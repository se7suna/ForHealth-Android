# GitLab CI/CD é…ç½®æ–‡ä»¶
# For Health åç«¯ CI/CD Pipeline

stages:
  - test        # æµ‹è¯•

variables:
  PYTHON_VERSION: "3.11-slim"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Docker é…ç½®ä¼˜åŒ–
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # å¢åŠ æ‹‰å–è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  GET_SOURCES_ATTEMPTS: 3
  RESTORE_CACHE_ATTEMPTS: 3

# ç¼“å­˜é…ç½®
cache:
  paths:
    - .cache/pip
    - backend/.venv/

# ==================== Test Stage ====================

test:integration:
  stage: test
  image: python:${PYTHON_VERSION}
  services:
    - mongo:latest
  variables:
    MONGODB_URL: "mongodb://mongo:27017"
    DATABASE_NAME: "test_for_health"
    SECRET_KEY: "test-secret-key-for-ci"
    SMTP_HOST: "smtp.test.com"
    SMTP_USER: "test@test.com"
    SMTP_PASSWORD: "test"
    SMTP_FROM_EMAIL: "noreply@test.com"
  before_script:
    - cd backend
    - apk update
    - apk add zbar
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
    - nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > server.log 2>&1 &
    - SERVER_PID=$!
    - echo "ğŸ“ æœåŠ¡å™¨è¿›ç¨‹ PID $SERVER_PID"
    - echo "â³ ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨..."
    - sleep 30
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - pytest tests/test_sports.py
  allow_failure: true
  tags:
    - runner_352  # ä½¿ç”¨å¸¦æœ‰ docker tag çš„ runner
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

# ==================== é€šçŸ¥ ====================

notify:success:
  stage: .post
  script:
    - echo "âœ… CI/CD Pipeline æ‰§è¡ŒæˆåŠŸï¼"
  tags:
    - runner_352
  when: on_success

notify:failure:
  stage: .post
  script:
    - echo "âŒ CI/CD Pipeline æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
  tags:
    - runner_352
  when: on_failure
