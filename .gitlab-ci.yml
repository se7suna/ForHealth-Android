image: python:3.11

services:
  - name: mongo:latest
    alias: mongo

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR/backend"
  MONGODB_URL: "mongodb://mongo:27017/for_health"
  DATABASE_NAME: "for_health"

stages:
  - test

cache:
  key: "$CI_COMMIT_REF_SLUG-pip"
  paths:
    - .cache/pip

before_script:
  - python --version
  - python -m pip install --upgrade pip
  - python -m pip install -r backend/requirements.txt

backend-test:
  tags:
    - runner_352
  stage: test
  script:
    - cd backend
    - |
      $process = Start-Process -FilePath "python" -ArgumentList @("-m","uvicorn","app.main:app","--host","0.0.0.0","--port","8000") -PassThru
      $env:APP_PID = $process.Id
      Write-Host "Started uvicorn with PID $($env:APP_PID)"
    - |
      $deadline = (Get-Date).AddSeconds(60)
      $uri = "http://127.0.0.1:8000/health"
      while ((Get-Date) -lt $deadline) {
          try {
              $response = Invoke-WebRequest -Uri $uri -UseBasicParsing -TimeoutSec 5
              if ($response.StatusCode -eq 200) {
                  Write-Host "Server is ready."
                  break
              }
          } catch {
              Start-Sleep -Seconds 2
          }
      }
      if ((Get-Date) -ge $deadline) {
          throw "Server failed to start in time."
      }
    - pytest tests/test_example.py -vv
  after_script:
    - |
      if ($env:APP_PID) {
          Write-Host "Stopping uvicorn process $($env:APP_PID)"
          try { Stop-Process -Id $env:APP_PID -Force } catch { Write-Host "Failed to stop process: $_" }
      }
