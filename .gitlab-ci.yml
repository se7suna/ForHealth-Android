image: python:3.11

services:
  - name: mongo:latest
    alias: mongo

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR/backend"
  MONGODB_URL: "mongodb://mongo:27017/for_health"
  DATABASE_NAME: "for_health"

stages:
  - test

cache:
  key: "$CI_COMMIT_REF_SLUG-pip"
  paths:
    - .cache/pip

before_script:
  - python --version
  - pip install --upgrade pip
  - pip install -r backend/requirements.txt

backend-test:
  tags:
    - runner_352
  stage: test
  script:
    - cd backend
    - uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    - export APP_PID=$!
    - |
      python - <<'PY'
      import time
      import urllib.request
      import urllib.error

      deadline = time.time() + 60
      url = "http://127.0.0.1:8000/health"

      while time.time() < deadline:
          try:
              with urllib.request.urlopen(url, timeout=5) as resp:
                  if resp.status == 200:
                      print("Server is ready.")
                      break
          except urllib.error.URLError:
              time.sleep(2)
      else:
          raise SystemExit("Server failed to start in time.")
      PY
    - pytest tests/test_example.py -vv
  after_script:
    - if [ -n "$APP_PID" ]; then kill $APP_PID; fi
