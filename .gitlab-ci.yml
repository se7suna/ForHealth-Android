# GitLab CI/CD é…ç½®æ–‡ä»¶
# For Health åç«¯ CI/CD Pipeline

stages:
  - test        # æµ‹è¯•
  - build       # æ„å»º

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # æœ¬åœ°Pythonè·¯å¾„ï¼ˆæ ¹æ®æœåŠ¡å™¨å®é™…ç¯å¢ƒè°ƒæ•´ï¼‰
  PYTHON_PATH: "/usr/bin/python3.11"
  PIP_PATH: "/usr/bin/pip3.11"
  # MongoDB Docker é…ç½®
  MONGO_CONTAINER_NAME: "ci-mongodb"
  MONGO_PORT: "27017"
  MONGO_IMAGE: "mongo:latest"

# ç¼“å­˜é…ç½®ï¼ˆé’ˆå¯¹æœ¬åœ°ç¯å¢ƒï¼‰
cache:
  paths:
    - .cache/pip
    - backend/.venv/
  key: "$CI_COMMIT_REF_SLUG"

# ==================== Test Stage ====================

test:unit:
  stage: test
  variables:
    MONGODB_URL: "mongodb://local:${MONGO_PORT}"
    DATABASE_NAME: "test_for_health"
    SECRET_KEY: "test-secret-key-for-ci"
    SMTP_HOST: "smtp.test.com"
    SMTP_USER: "test@test.com"
    SMTP_PASSWORD: "test"
    SMTP_FROM_EMAIL: "noreply@test.com"
  before_script:
    # å¯åŠ¨MongoDBå®¹å™¨
    - echo "ğŸ“¦ å¯åŠ¨MongoDBå®¹å™¨..."
    - docker run -d --name ${MONGO_CONTAINER_NAME} -p ${MONGO_PORT}:27017 ${MONGO_IMAGE}
    - sleep 5  # ç­‰å¾…å®¹å™¨å¯åŠ¨
    # å‡†å¤‡Pythonç¯å¢ƒ
    - cd backend
    - $PIP_PATH install --upgrade pip
    - $PIP_PATH install -r requirements.txt
  script:
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - $PYTHON_PATH -m pytest tests/ -v --tb=short --junitxml=test-results.xml
  after_script:
    # æ¸…ç†MongoDBå®¹å™¨
    - echo "ğŸ§¹ æ¸…ç†MongoDBå®¹å™¨..."
    - docker stop ${MONGO_CONTAINER_NAME} || true
    - docker rm ${MONGO_CONTAINER_NAME} || true
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    when: always
    paths:
      - backend/test-results.xml
    reports:
      junit: backend/test-results.xml
  tags:
    - shell  # ä½¿ç”¨shellæ‰§è¡Œå™¨ï¼ˆéœ€æå‰é…ç½®ï¼‰
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

test:integration:
  stage: test
  variables:
    MONGODB_URL: "mongodb://localhost:${MONGO_PORT}"
    DATABASE_NAME: "test_for_health"
    SECRET_KEY: "test-secret-key-for-ci"
    SMTP_HOST: "smtp.test.com"
    SMTP_USER: "test@test.com"
    SMTP_PASSWORD: "test"
    SMTP_FROM_EMAIL: "noreply@test.com"
  before_script:
    # å¯åŠ¨MongoDBå®¹å™¨
    - echo "ğŸ“¦ å¯åŠ¨MongoDBå®¹å™¨..."
    - docker run -d --name ${MONGO_CONTAINER_NAME} -p ${MONGO_PORT}:27017 ${MONGO_IMAGE}
    - sleep 5  # ç­‰å¾…å®¹å™¨å¯åŠ¨
    # å‡†å¤‡Pythonç¯å¢ƒ
    - cd backend
    - $PIP_PATH install --upgrade pip
    - $PIP_PATH install -r requirements.txt
  script:
    - echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆå¾…å®ç°ï¼‰"
  after_script:
    # æ¸…ç†MongoDBå®¹å™¨
    - echo "ğŸ§¹ æ¸…ç†MongoDBå®¹å™¨..."
    - docker stop ${MONGO_CONTAINER_NAME} || true
    - docker rm ${MONGO_CONTAINER_NAME} || true
  allow_failure: true
  tags:
    - shell
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

# ==================== Build Stage ====================

build:backend:
  stage: build
  before_script:
    - cd backend
    - $PIP_PATH install --upgrade pip
    - $PIP_PATH install -r requirements.txt
  script:
    - echo "ğŸ—ï¸ æ„å»ºåç«¯åº”ç”¨..."
    - $PYTHON_PATH -m py_compile app/**/*.py
    - echo "âœ… æ„å»ºæˆåŠŸ"
  artifacts:
    paths:
      - backend/
    expire_in: 1 day
  tags:
    - shell
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

# ==================== é€šçŸ¥ ====================
notify:success:
  stage: .post
  script:
    - echo "âœ… CI/CD Pipeline æ‰§è¡ŒæˆåŠŸï¼"
  tags:
    - shell
  when: on_success

notify:failure:
  stage: .post
  script:
    - echo "âŒ CI/CD Pipeline æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
  tags:
    - shell
  when: on_failure