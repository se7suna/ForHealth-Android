# GitLab CI/CD é…ç½®æ–‡ä»¶
# For Health åç«¯ CI/CD Pipeline

stages:
  - test        # æµ‹è¯•
  - build       # æ„å»º

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  # Docker é…ç½®ä¼˜åŒ–
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # å¢åŠ æ‹‰å–è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  GET_SOURCES_ATTEMPTS: 3
  RESTORE_CACHE_ATTEMPTS: 3

# ç¼“å­˜é…ç½®
cache:
  paths:
    - .cache/pip
    - backend/.venv/

# ==================== Test Stage ====================

test:unit:
  stage: test
  image: python:${PYTHON_VERSION}
  services:
    - name: mongo:latest
      alias: mongo
    - name: mailhog/mailhog:latest
      alias: mailhog
  variables:
    MONGODB_URL: "mongodb://mongo:27017"
    DATABASE_NAME: "test_for_health"
    SECRET_KEY: "test-secret-key-for-ci"
    # ä½¿ç”¨ MailHog é‚®ä»¶æœåŠ¡å™¨
    SMTP_HOST: "mailhog"
    SMTP_PORT: "1025"
    SMTP_USER: ""
    SMTP_PASSWORD: ""
    SMTP_FROM_EMAIL: "noreply@forhealth.com"
    SMTP_FROM_NAME: "For Health Test"
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio httpx
  script:
    - echo "ğŸ§ª å‡†å¤‡è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡å™¨..."
    # åœ¨åå°å¯åŠ¨æœåŠ¡å™¨
    - nohup uvicorn app.main:app --host 127.0.0.1 --port 8000 > server.log 2>&1 &
    - SERVER_PID=$!
    - echo "ğŸ“ æœåŠ¡å™¨è¿›ç¨‹ PID: $SERVER_PID"
    - echo "â³ ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨..."
    # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾… 30 ç§’ï¼‰
    - |
      for i in {1..30}; do
        if curl -s http://127.0.0.1:8000/health > /dev/null 2>&1; then
          echo "âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼"
          break
        fi
        if [ $i -eq 30 ]; then
          echo "âŒ æœåŠ¡å™¨å¯åŠ¨è¶…æ—¶"
          cat server.log
          exit 1
        fi
        echo "ç­‰å¾…ä¸­... ($i/30)"
        sleep 1
      done
    - echo "ğŸ‘¤ åˆ›å»ºæµ‹è¯•ç”¨æˆ·..."
    # åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    - |
      python3 << 'PYTHON_SCRIPT'
      import httpx
      import asyncio
      
      async def create_test_user():
          """åˆ›å»ºæµ‹è¯•ç”¨æˆ·"""
          async with httpx.AsyncClient(base_url="http://127.0.0.1:8000", timeout=30.0) as client:
              # å°è¯•æ³¨å†Œæµ‹è¯•ç”¨æˆ·
              try:
                  response = await client.post(
                      "/api/auth/register",
                      json={
                          "email": "user@example.com",
                          "username": "testuser",
                          "password": "string"
                      }
                  )
                  if response.status_code == 201:
                      print("âœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸ")
                  elif response.status_code == 409:
                      print("â„¹ï¸ æµ‹è¯•ç”¨æˆ·å·²å­˜åœ¨")
                  else:
                      print(f"âš ï¸ åˆ›å»ºæµ‹è¯•ç”¨æˆ·è¿”å›çŠ¶æ€ç : {response.status_code}")
              except Exception as e:
                  print(f"âŒ åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¤±è´¥: {e}")
                  exit(1)
      
      asyncio.run(create_test_user())
      PYTHON_SCRIPT
    - echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
    - pytest tests/ -v --tb=short --junitxml=test-results.xml
  after_script:
    - cd backend
    - echo "ğŸ›‘ åœæ­¢æœåŠ¡å™¨..."
    # åœæ­¢æœåŠ¡å™¨è¿›ç¨‹
    - kill $SERVER_PID || true
    - sleep 2
    # å¦‚æœè¿˜åœ¨è¿è¡Œï¼Œå¼ºåˆ¶åœæ­¢
    - kill -9 $SERVER_PID || true
    - echo "ğŸ“‹ æœåŠ¡å™¨æ—¥å¿—ï¼š"
    - cat server.log || true
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    when: always
    paths:
      - backend/test-results.xml
    reports:
      junit: backend/test-results.xml
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 30m
  tags:
    - docker
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - docker-compose.yml

# é‚®ç®±æœåŠ¡å™¨åŠŸèƒ½æµ‹è¯•
test:email-service:
  stage: test
  image: python:${PYTHON_VERSION}
  services:
    - name: mailhog/mailhog:latest
      alias: mailhog
  variables:
    SMTP_HOST: "mailhog"
    SMTP_PORT: "1025"
  before_script:
    - pip install --upgrade pip
    - pip install aiosmtplib
  script:
    - echo "ğŸ“§ æµ‹è¯•é‚®ç®±æœåŠ¡å™¨è¿æ¥å’Œé‚®ä»¶å‘é€..."
    - |
      python3 << 'EOF'
      import asyncio
      import aiosmtplib
      from email.mime.text import MIMEText
      from email.mime.multipart import MIMEMultipart

      async def test_email_connection():
          """æµ‹è¯•é‚®ç®±æœåŠ¡å™¨è¿æ¥"""
          try:
              # åˆ›å»ºé‚®ä»¶
              message = MIMEMultipart()
              message["From"] = "noreply@forhealth.com"
              message["To"] = "test@example.com"
              message["Subject"] = "CI/CD é‚®ä»¶æœåŠ¡æµ‹è¯•"

              body = """
              <html>
                <body>
                  <h2>é‚®ä»¶æœåŠ¡å™¨æµ‹è¯•</h2>
                  <p>è¿™æ˜¯ä¸€å°æ¥è‡ª CI/CD æµæ°´çº¿çš„æµ‹è¯•é‚®ä»¶ã€‚</p>
                  <p>å¦‚æœæ‚¨æ”¶åˆ°è¿™å°é‚®ä»¶ï¼Œè¯´æ˜é‚®ä»¶æœåŠ¡å™¨å·¥ä½œæ­£å¸¸ï¼</p>
                </body>
              </html>
              """
              message.attach(MIMEText(body, "html"))

              # å‘é€é‚®ä»¶
              await aiosmtplib.send(
                  message,
                  hostname="mailhog",
                  port=1025,
              )

              print("âœ… é‚®ä»¶å‘é€æˆåŠŸï¼")
              print("ğŸ“¬ æ”¶ä»¶äºº: test@example.com")
              print("ğŸ“ ä¸»é¢˜: CI/CD é‚®ä»¶æœåŠ¡æµ‹è¯•")
              return True
          except Exception as e:
              print(f"âŒ é‚®ä»¶å‘é€å¤±è´¥: {e}")
              return False

      # è¿è¡Œæµ‹è¯•
      result = asyncio.run(test_email_connection())

      if result:
          print("\nğŸ‰ é‚®ç®±æœåŠ¡å™¨æµ‹è¯•é€šè¿‡ï¼")
          exit(0)
      else:
          print("\nğŸ’¥ é‚®ç®±æœåŠ¡å™¨æµ‹è¯•å¤±è´¥ï¼")
          exit(1)
      EOF
    - echo "âœ… é‚®ç®±æœåŠ¡å™¨æµ‹è¯•å®Œæˆï¼"
  tags:
    - docker  # ä½¿ç”¨å¸¦æœ‰ docker tag çš„ runner
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - docker-compose.yml

test:integration:
  stage: test
  image: python:${PYTHON_VERSION}
  services:
    - mongo:latest
  variables:
    MONGODB_URL: "mongodb://mongo:27017"
    DATABASE_NAME: "test_for_health"
    SECRET_KEY: "test-secret-key-for-ci"
    SMTP_HOST: "smtp.test.com"
    SMTP_USER: "test@test.com"
    SMTP_PASSWORD: "test"
    SMTP_FROM_EMAIL: "noreply@test.com"
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "ğŸ”— è¿è¡Œé›†æˆæµ‹è¯•..."
    - echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆå¾…å®ç°ï¼‰"
  allow_failure: true
  tags:
    - docker  # ä½¿ç”¨å¸¦æœ‰ docker tag çš„ runner
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

# ==================== Build Stage ====================

build:backend:
  stage: build
  image: python:${PYTHON_VERSION}
  before_script:
    - cd backend
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "ğŸ—ï¸ æ„å»ºåç«¯åº”ç”¨..."
    - python -m py_compile app/**/*.py
    - echo "âœ… æ„å»ºæˆåŠŸ"
  artifacts:
    paths:
      - backend/
    expire_in: 1 day
  tags:
    - docker  # ä½¿ç”¨å¸¦æœ‰ docker tag çš„ runner
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

# ==================== é€šçŸ¥ ====================

notify:success:
  stage: .post
  script:
    - echo "âœ… CI/CD Pipeline æ‰§è¡ŒæˆåŠŸï¼"
  tags:
    - docker
  when: on_success

notify:failure:
  stage: .post
  script:
    - echo "âŒ CI/CD Pipeline æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
  tags:
    - docker
  when: on_failure
