# For Health 前后端联调测试指南

## 📋 准备工作

### 1. 启动后端服务

在后端目录下启动FastAPI服务：

```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**验证后端启动成功：**
- 浏览器访问：http://localhost:8000/docs
- 应该能看到Swagger API文档界面

### 2. 确认网络配置

#### Android模拟器
- 使用 `10.0.2.2` 访问本机的 `localhost`
- 已在 `RetrofitClient.kt` 中配置：`http://10.0.2.2:8000/`

#### 真机测试
需要修改 `RetrofitClient.kt` 中的 `BASE_URL`：

```kotlin
// 将 10.0.2.2 改为你电脑的局域网IP
private const val BASE_URL = "http://192.168.1.xxx:8000/"
```

**获取电脑局域网IP：**
- Windows: 运行 `ipconfig`，查看 IPv4 地址
- Mac/Linux: 运行 `ifconfig` 或 `ip addr`

**确保手机和电脑在同一WiFi网络**

### 3. 构建前端应用

在Android Studio中：
1. 点击 `Build` -> `Rebuild Project`
2. 等待Gradle同步和构建完成
3. 点击 `Run` 按钮或按 `Shift+F10`

## 🧪 功能测试流程

### 测试1: 新用户注册流程

**步骤：**
1. 启动应用 → 看到登录页面
2. 点击"注册"按钮
3. 填写注册信息：
   - 用户名：`测试用户`
   - 邮箱：`test@example.com`
   - 密码：`123456`
   - 确认密码：`123456`
4. 点击"注册"按钮

**预期结果：**
- 显示"注册成功，请填写个人信息"
- 自动登录并获取Token
- 跳转到身体数据填写页面

**后端验证：**
查看后端日志，应该看到：
```
POST /api/auth/register - 201
POST /api/auth/login - 200
```

### 测试2: 填写身体数据

**步骤：**
1. 性别：选择"男"或"女"
2. 出生日期：选择合适的日期
3. 身高：选择身高（例如：175 cm）
4. 体重：选择体重（例如：70 kg）
5. 点击"下一步"

**预期结果：**
- 跳转到活动水平选择页面
- 数据正确传递到下一页

### 测试3: 选择活动水平

**步骤：**
1. 选择活动水平：例如"中度活跃"
2. 点击"下一步"

**预期结果：**
- 跳转到健康目标设定页面

### 测试4: 设定健康目标

**步骤：**
1. 目标类型：选择"减重"/"维持体重"/"增重"
2. 目标体重：选择目标体重（例如：65 kg）
3. 目标周期：选择周期（例如：10 周）
4. 点击"下一步"

**预期结果：**
- 显示"信息保存成功"
- 跳转到主页面
- 后端日志显示 `PUT /api/user/profile - 200`

**后端验证：**
在Swagger文档中调用 `GET /api/user/profile`，检查数据是否正确保存。

### 测试5: 查看个人信息

**步骤：**
1. 在主页点击右上角个人信息图标
2. 查看个人信息页面

**预期结果：**
- 显示完整的用户信息：
  - 基本信息（邮箱、性别、出生日期）
  - 身体数据（身高、体重、活动水平）
  - 健康目标（目标类型、目标体重、目标周期）
- 中文字段正确显示（例如："男"而不是"male"）
- 后端日志显示 `GET /api/user/profile - 200`

### 测试6: 退出登录

**步骤：**
1. 在主页点击右上角菜单
2. 点击"退出登录"

**预期结果：**
- 跳转到登录页面
- Token被清除

### 测试7: 老用户登录

**步骤：**
1. 启动应用
2. 输入已注册的邮箱和密码
3. 点击"登录"

**预期结果：**
- 显示"登录成功"
- 直接跳转到主页面（因为用户已完成数据填写）
- 后端日志显示 `POST /api/auth/login - 200`

## 🔍 调试技巧

### 1. 查看网络请求日志

在Android Studio的Logcat中查看网络请求：
- 过滤：`OkHttp` 或 `RetrofitClient`
- 应该能看到完整的HTTP请求和响应

### 2. 使用Swagger测试后端

访问 http://localhost:8000/docs：
- 测试注册API
- 测试登录API并获取Token
- 使用Token测试其他API

### 3. 常见问题排查

#### 问题1: "网络错误: Failed to connect"
**解决方法：**
- 检查后端是否正常运行
- 检查BASE_URL配置是否正确
- 确保防火墙允许8000端口

#### 问题2: "401 Unauthorized"
**解决方法：**
- Token可能已过期或无效
- 重新登录获取新Token
- 检查Authorization header格式

#### 问题3: 注册后无法登录
**解决方法：**
- 检查后端日志，确认注册是否成功
- 确认密码输入正确
- 尝试使用Swagger测试登录接口

#### 问题4: 数据保存失败
**解决方法：**
- 检查后端日志查看具体错误
- 确认所有必填字段都已填写
- 检查数据格式是否正确（例如日期格式）

#### 问题5: 中文显示为英文
**解决方法：**
- 检查DataMapper是否正确调用
- 确认ProfileActivity使用了DataMapper转换

## 📊 测试检查清单

- [ ] 新用户注册成功
- [ ] 注册后自动登录
- [ ] 身体数据填写完整
- [ ] 活动水平选择正常
- [ ] 健康目标设定成功
- [ ] 数据成功保存到后端
- [ ] 主页正常显示
- [ ] 个人信息正确显示
- [ ] 中文字段转换正确
- [ ] 退出登录正常
- [ ] 老用户登录成功
- [ ] 老用户直接进入主页

## 🔒 测试账号

如果想用固定账号测试，可以先在Swagger中注册：

**测试账号1：**
- 用户名：`张三`
- 邮箱：`zhangsan@example.com`
- 密码：`123456`

**测试账号2：**
- 用户名：`李四`
- 邮箱：`lisi@example.com`
- 密码：`123456`

## 📝 数据验证

### 在MongoDB中验证数据

如果需要直接查看数据库：

```bash
# 连接到MongoDB
mongosh

# 切换到数据库
use forhealth

# 查看所有用户
db.users.find().pretty()

# 查看特定用户
db.users.findOne({ email: "test@example.com" })
```

### 验证数据完整性

检查用户文档应该包含：
- `email`, `username`, `hashed_password`
- `gender`, `birthdate`, `height`, `weight`
- `age` (动态计算)
- `activity_level`
- `health_goal_type`, `target_weight`, `goal_period_weeks`
- `bmr`, `tdee`, `daily_calorie_goal`

## 🎯 性能测试

### 网络延迟测试

可以在RetrofitClient中调整超时时间：

```kotlin
.connectTimeout(30, TimeUnit.SECONDS)
.readTimeout(30, TimeUnit.SECONDS)
.writeTimeout(30, TimeUnit.SECONDS)
```

### 并发测试

多次快速点击按钮，确保：
- 不会重复提交请求
- 错误处理正常
- UI状态正确

## 📱 设备兼容性测试

建议在以下环境测试：
- [ ] Android模拟器（API 26+）
- [ ] 真机（不同Android版本）
- [ ] 不同屏幕尺寸

## 🚀 下一步优化建议

1. **添加加载动画**：网络请求时显示loading
2. **错误提示优化**：更友好的错误信息
3. **网络缓存**：减少重复请求
4. **Token刷新**：自动刷新过期Token
5. **离线模式**：本地缓存用户数据
6. **数据校验**：更严格的前端验证

## 📚 相关文档

- [前后端API协作文档](./前后端API协作文档.md)
- [前端功能更新说明](./前端功能更新说明.md)
- [前后端对接指南](./前后端对接指南.md)
- [后端README](./后端README.md)


