# For Health 食物食谱系统完整指南

版本：v2.0  
更新时间：2024-11-17

---

## 📋 目录

1. [系统概述](#系统概述)
2. [核心功能](#核心功能)
3. [快速开始](#快速开始)
4. [API端点速览](#api端点速览)
5. [使用场景](#使用场景)
6. [测试指南](#测试指南)
7. [注意事项](#注意事项)

---

## 系统概述

食物食谱系统提供完整的食物营养管理功能，包括：

### 功能模块

| 模块 | 功能 |
|------|------|
| **食物管理** | 创建、搜索、更新、删除食物信息 |
| **食物记录** | 记录每日食物摄入，支持单个/批量记录 |
| **食谱管理** | 创建、搜索、管理食谱（多个食物的组合） |
| **食谱记录** | 通过食谱快速记录，自动创建多条食物记录 |
| **条形码扫描** | 通过条形码快速查询食品信息 |
| **图片识别** | 上传图片自动识别条形码（pyzbar + opencv） |

### 数据来源

- **本地数据库**：用户创建的食物/食谱 + 系统预置数据
- **薄荷健康API**：搜索时自动调用，结果自动缓存到本地
- **条形码API**：通过条形码查询食品详细信息

---

## 核心功能

### 1. 食物管理

#### 权限控制

| 食物类型 | 可见性 | 编辑/删除 |
|---------|--------|----------|
| 系统食物（`created_by="all"`） | 所有用户 | ❌ 只读 |
| 用户创建 | 仅创建者 | ✅ 完全控制 |
| 薄荷缓存（`source="boohee"`） | 所有用户 | ❌ 只读 |

#### 核心特性
- ✅ 薄荷健康搜索结果自动落地本地库
- ✅ 通过本地 ObjectId 统一访问
- ✅ 营养数据快照（历史记录不受修改影响）
- ✅ 按名称、分类、品牌搜索
- ✅ 支持简化/完整营养信息

### 2. 食谱管理

#### 食谱类型

| 类型 | 创建者 | 可见性 | 权限 |
|------|--------|--------|------|
| 系统食谱 | `created_by="all"` | 所有用户 | 只读 |
| 用户食谱 | `created_by=邮箱` | 仅创建者 | 完全控制 |

#### 核心特性
- ✅ 食谱 = 多个食物的组合
- ✅ 自动计算总营养
- ✅ 支持标签、分类筛选
- ✅ 通过食谱快速记录（一键记录多个食物）

### 3. 食物记录

#### 记录方式

```
方式1: 单个记录    POST /api/food/record
方式2: 批量记录    POST /api/food/record/batch
方式3: 食谱记录    POST /api/recipe/record  ⭐推荐
```

#### 核心特性
- ✅ 支持餐次分类（早/午/晚/加餐）
- ✅ 自动计算营养总和
- ✅ 按日期范围查询
- ✅ 每日营养摘要
- ✅ 食谱记录自动标记来源

### 4. 条形码扫描

#### 两种扫描方式

**方式1：图片识别（推荐）**
```
POST /api/food/barcode/recognize
上传图片 → 识别条形码 → 查询食品
```

**方式2：直接查询**
```
GET /api/food/barcode/{barcode}
条形码 → 查询食品
```

#### 查询策略
```
1. 本地数据库（速度快）
   ↓ 未找到
2. 薄荷健康API
   ↓ 未找到
3. 提示手动录入
```

---

## 快速开始

### 1. 环境准备

```bash
# 启动 MongoDB
mongod

# 安装依赖
cd backend
pip install -r requirements.txt
```

### 2. 初始化数据

```bash
# 初始化食物数据（12种常见食物）
python -m app.init_db.init_food_data

# 初始化食谱数据（6个系统食谱）
python -m app.init_db.init_recipe_data
```

### 3. 启动服务

```bash
# 启动后端
uvicorn app.main:app --reload

# 访问 API 文档
http://localhost:8000/docs
```

### 4. 测试流程

#### 步骤1：注册登录
```json
POST /api/auth/register
{
  "email": "test@example.com",
  "username": "测试用户",
  "password": "Test123456"
}

POST /api/auth/login
→ 获取 access_token
```

#### 步骤2：设置认证
```
Swagger UI → Authorize → Bearer <token>
```

#### 步骤3：测试功能
- 搜索食物：`GET /api/food/search?keyword=鸡蛋`
- 创建食物：`POST /api/food/`
- 搜索食谱：`GET /api/recipe/search`
- 记录摄入：`POST /api/food/record`

---

## API端点速览

### 食物管理（6个）

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/food/` | 创建食物 |
| GET | `/api/food/search` | 搜索食物（薄荷API） |
| GET | `/api/food/search-id` | 按名称搜索ID |
| GET | `/api/food/{food_id}` | 获取详情 |
| PUT | `/api/food/{food_id}` | 更新食物 |
| DELETE | `/api/food/{food_id}` | 删除食物 |

### 食物记录（5个）

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/food/record` | 单个记录 |
| POST | `/api/food/record/batch` | 批量记录 |
| GET | `/api/food/record/list` | 记录列表 |
| GET | `/api/food/record/daily/{date}` | 每日摘要 |
| PUT/DELETE | `/api/food/record/{id}` | 更新/删除 |

### 食谱管理（7个）

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/recipe/` | 创建食谱 |
| GET | `/api/recipe/search` | 搜索食谱 |
| GET | `/api/recipe/search-id` | 按名称搜索ID |
| GET | `/api/recipe/categories` | 获取分类 |
| GET | `/api/recipe/{id}` | 获取详情 |
| PUT | `/api/recipe/{id}` | 更新食谱 |
| DELETE | `/api/recipe/{id}` | 删除食谱 |

### 食谱记录（4个）

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/recipe/record` | 创建记录（⭐推荐） |
| GET | `/api/recipe/record` | 记录列表 |
| PUT | `/api/recipe/record/{batch_id}` | 更新记录 |
| DELETE | `/api/recipe/record/{batch_id}` | 删除记录 |

### 条形码扫描（2个）

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/api/food/barcode/recognize` | 图片识别条形码 |
| GET | `/api/food/barcode/{barcode}` | 查询食品信息 |

---

## 使用场景

### 场景1：记录单个食物

```http
GET /api/food/search?keyword=鸡蛋
→ 获取食物ID

POST /api/food/record
{
  "food_id": "...",
  "serving_amount": 2,
  "recorded_at": "2024-11-17T08:00:00",
  "meal_type": "早餐"
}
```

### 场景2：通过食谱快速记录（推荐）

```http
GET /api/recipe/search?keyword=健康早餐
→ 获取食谱ID

POST /api/recipe/record
{
  "recipe_id": "...",
  "scale": 1.0,
  "recorded_at": "2024-11-17T08:00:00",
  "meal_type": "早餐"
}
→ 自动为食谱中的所有食物创建记录
```

### 场景3：条形码扫描记录

```http
# 方式1：上传图片识别
POST /api/food/barcode/recognize
file: <图片文件>
→ 返回条形码

# 方式2：直接查询
GET /api/food/barcode/{barcode}
→ 返回食品信息

# 保存记录
POST /api/food/record
{
  "food_id": "...",
  "serving_amount": 1.5,
  "recorded_at": "...",
  "meal_type": "午餐"
}
```

### 场景4：查看每日营养

```http
GET /api/food/record/daily/2024-11-17
→ 返回当天所有记录和营养总计
```

---

## 测试指南

### 完整测试流程

#### 1. 食物管理测试

```
✅ 搜索食物（无条件/按关键词/按分类）
✅ 创建自定义食物
✅ 获取食物详情
✅ 更新食物信息
✅ 删除食物
✅ 验证权限控制
```

#### 2. 食谱管理测试

```
✅ 搜索食谱（系统+用户）
✅ 创建自定义食谱
✅ 获取食谱详情
✅ 更新食谱
✅ 删除食谱
✅ 尝试删除系统食谱（应失败）
```

#### 3. 食物记录测试

```
✅ 单个记录创建
✅ 批量记录创建
✅ 通过食谱记录
✅ 混合记录（食物+食谱）
✅ 查询记录列表
✅ 按日期/餐次筛选
✅ 获取每日摘要
✅ 更新/删除记录
```

#### 4. 食谱记录测试

```
✅ 创建食谱记录（不同 scale）
✅ 查询食谱记录
✅ 按日期/餐次筛选
✅ 更新记录（时间/餐次/备注）
✅ 尝试更新 scale（应失败）
✅ 删除批次
✅ 验证食物记录标记
```

#### 5. 条形码扫描测试

```
✅ 图片识别条形码
✅ 有效条形码查询
✅ 无效条形码处理
✅ 本地数据库查询
✅ 外部API查询
✅ 未找到商品处理
```

### 验证清单

**数据准确性**
- [ ] 营养数据计算正确
- [ ] 份量倍数应用正确
- [ ] 时间记录准确（recorded_at vs created_at）
- [ ] 批次管理正确（batch_id）

**权限控制**
- [ ] 需要登录才能访问
- [ ] 只能编辑/删除自己的数据
- [ ] 系统食物/食谱只读
- [ ] 用户数据私有（不可见他人）

**功能完整性**
- [ ] 搜索功能正常
- [ ] 创建功能正常
- [ ] 更新功能正常
- [ ] 删除功能正常
- [ ] 记录功能正常
- [ ] 统计功能正常

---

## 注意事项

### 1. 数据模型

#### 营养数据结构
```json
{
  "calories": 52.0,        // 卡路里（千卡）- 必填
  "protein": 0.3,          // 蛋白质（克）- 必填
  "carbohydrates": 14.0,   // 碳水化合物（克）- 必填
  "fat": 0.2,              // 脂肪（克）- 必填
  "fiber": 2.4,            // 膳食纤维（克）- 可选
  "sugar": 10.0,           // 糖分（克）- 可选
  "sodium": 1.0            // 钠（毫克）- 可选
}
```

#### 时间字段说明
```json
{
  "recorded_at": "摄入时间（用户实际吃的时间）",
  "created_at": "记录时间（系统记录的时间）"
}
```

### 2. 权限规则

| 数据类型 | created_by | 可见性 | 编辑 | 删除 |
|---------|-----------|--------|------|------|
| 系统食物/食谱 | "all" | 所有人 | ❌ | ❌ |
| 薄荷缓存 | "all" | 所有人 | ❌ | ❌ |
| 用户食物/食谱 | 用户邮箱 | 仅本人 | ✅ | ✅ |
| 食物/食谱记录 | - | 仅本人 | ✅ | ✅ |

### 3. 食谱记录特点

✅ **支持**：
- 创建记录时指定 `scale`（份量倍数）
- 更新 `recorded_at`、`meal_type`、`notes`
- 删除整个批次（batch）

❌ **不支持**：
- 修改 `scale`（如需修改，请删除后重新创建）

### 4. 条形码扫描

#### 图片识别
- 支持格式：JPG, PNG, BMP
- 支持类型：EAN-13, EAN-8, UPC-A, CODE128, QR Code
- 自动图像预处理提高识别率

#### 查询策略
```
本地数据库（< 100ms）
    ↓ 未找到
薄荷健康API（< 3s）
    ↓ 未找到
提示手动录入
```

### 5. 最佳实践

#### 食物记录
- ✅ 使用食谱记录（简单、自动、可追溯）
- ✅ 批量记录（一次记录多个食物）
- ⚠️ 单个记录（适合零食、加餐）

#### 营养计算
```javascript
// 前端需要根据份量计算实际营养
actualNutrition = nutrition_per_serving × serving_amount

// 食谱记录需要根据 scale 调整
scaledNutrition = nutrition × scale
```

#### 数据同步
- 薄荷搜索结果自动缓存到本地（`created_by="all"`）
- 首次扫描的条形码食品建议保存到本地
- 使用本地 ObjectId 统一管理

### 6. 性能优化

- 搜索优先使用本地数据库
- 薄荷API结果自动缓存
- 条形码查询优先本地
- 使用索引优化查询

### 7. 前端集成建议

#### 图片识别流程
```javascript
// 1. 上传图片识别条形码
const formData = new FormData();
formData.append('file', imageFile);
const response = await fetch('/api/food/barcode/recognize', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});

// 2. 获取条形码后查询食品
const { barcode } = await response.json();
const foodData = await fetch(`/api/food/barcode/${barcode}`);

// 3. 确认份量后保存记录
await saveFoodRecord({ food_id, serving_amount, ... });
```

#### 食谱记录流程
```javascript
// 1. 获取食谱详情
const recipe = await fetch(`/api/recipe/${recipe_id}`);

// 2. 用户调整 scale
const scale = 1.5;

// 3. 创建食谱记录（后端自动处理）
await fetch('/api/recipe/record', {
  method: 'POST',
  body: JSON.stringify({
    recipe_id,
    scale,
    recorded_at,
    meal_type
  })
});
```

---

## 常见问题

### Q1: 如何区分不同来源的食物？
**A**: 通过 `source` 字段：
- `local`: 本地创建
- `boohee`: 薄荷健康
- 通过 `created_by` 区分系统（"all"）和用户（邮箱）

### Q2: 食谱记录和批量记录有什么区别？
**A**: 
- 食谱记录：`POST /api/recipe/record`，自动创建多条记录，统一管理（batch_id）
- 批量记录：`POST /api/food/record/batch`，手动指定每个食物，更灵活

### Q3: 如何确保历史记录准确？
**A**: 记录时保存营养数据快照，后续修改食物信息不影响历史记录。

### Q4: 条形码识别失败怎么办？
**A**: 
1. 重新拍照（确保清晰、光线充足）
2. 手动输入条形码
3. 手动录入食物信息

### Q5: 如何处理外部API查询结果？
**A**: 外部查询结果需要先保存到本地食物库（`POST /api/food/`），获取本地ID后再创建记录。

---

## 相关文档

- [后端API接口定义库](./后端API接口定义库.md) - 完整API文档
- [前后端API对接指南](./前后端API对接指南.md) - 对接说明
- Swagger UI: `http://localhost:8000/docs` - 在线API文档

---

**版本**: v2.0  
**更新时间**: 2024-11-17  
**状态**: ✅ 功能完整，文档齐全

