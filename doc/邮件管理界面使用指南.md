# 📧 邮件管理界面使用指南

本指南介绍如何使用 For Health 项目的邮件管理界面，包括实时监控、队列管理、日志查看等功能。

---

## 🎯 管理界面概览

本项目配置了 3 个邮件管理界面：

| 界面 | 地址 | 功能 | 主要用途 |
|------|------|------|----------|
| **MailHog UI** | http://ip:8025 | 邮件拦截查看 | 调试时查看发送的邮件内容 |
| **MailCatcher UI** | http://ip:8027 | Postfix 队列监控 | 查看邮件队列、重发、删除等 |
| **PostfixAdmin** | http://ip:8026 | 用户管理界面 | 管理邮箱用户（可选） |

---

## 📋 访问方式

### 当前配置的管理界面

#### 1️⃣ **MailHog/Mailpit 邮件查看界面**
- 地址：`http://124.70.161.90:8025`
- 功能：
  - 实时查看所有发送的邮件
  - 查看邮件内容、Headers、源代码
  - 邮件搜索和筛选
  - 邮件持久化存储（数据卷保存）

#### 2️⃣ **原生 Postfix 管理工具**（推荐）
- 地址：命令行工具
- 功能：
  - 查看邮件队列：`postqueue -p`
  - 清除队列邮件：`postsuper -d ALL`
  - 强制重试发送：`postqueue -f`
  - 实时日志：`tail -f /var/log/mail.log`

---

## 🛠️ Postfix 队列管理（实际使用）

### 基本命令

```bash
# 查看当前的邮件队列
sudo docker exec for_health_postfix postqueue -p

# 查看队列统计信息
curl -s http://124.70.161.90:8000/api/admin/mail/status

# 强制重试所有未发送的邮件
sudo docker exec for_health_postfix postqueue -f

# 删除特定邮件（替换 ID 为实际 ID）
sudo docker exec for_health_postfix postsuper -d 12345678

# 清空整个邮件队列（谨慎操作）
sudo docker exec for_health_postfix postsuper -d ALL
```

### 实时监控邮件日志

```bash
# 实时查看 Postfix 发送日志
sudo docker logs for_health_postfix -f

# 查看最近 50 条日志
sudo docker logs for_health_postfix --tail 50

# 查看包含特定邮箱的日志
sudo docker logs for_health_postfix 2> | grep "user@gmail.com"
```

---

## 🔍 MailHog 使用详解

### 访问和界面功能

1. **打开界面**：`http://124.70.161.90:8025`
2. **界面功能**：
   - 📬 **收件箱**：显示所有拦截的邮件
   - 🔍 **搜索**：按发件人、收件人、主题搜索
   - 🗂️ **筛选器**：按时间、状态筛选
   - ⬇️ **源代码**：查看原始邮件格式
   - 📊 **统计**：邮件发送统计

### MailHog vs 实际发送

**注意区分：**
- **MailHog (端口 1025)**：只拦截，不实际发送 → 用于调试
- **Postfix (端口 25)**：真实发送邮件 → 实际生产使用

### 配置 MailHog 用于调试

如果需要使用 MailHog 调试邮件发送（不实际发送到真实邮箱）：

**临时修改配置：**
```bash
# 临时切换到 MailHog（端口 1025）
nano backend/.env.production
# 修改：SMTP_HOST=localhost
# 修改：SMTP_PORT=1025
# 修改：SMTP_FROM_EMAIL=test@forhealth.com
```

**测试后切换回 Postfix：**
```bash
# 切换回 Postfix（端口 25）
sed -i 's/SMTP_HOST=localhost/SMTP_HOST=postfix/' backend/.env.production
sed -i 's/SMTP_PORT=1025/SMTP_PORT=25/' backend/.env.production
sed -i 's/SMTP_FROM_EMAIL=test@forhealth.com/SMTP_FROM_EMAIL=noreply@forhealth.com/' backend/.env.production
```

---

## 📈 统计和监控

### 1. 邮件发送统计

```bash
# 查看邮件统计
sudo docker exec for_health_postfix postqueue -j | jq '.'

# 查看发送成功率
sudo docker logs for_health_postfix 2> | grep -c "status=sent"
sudo docker logs for_health_postfix 2> | grep -c "status=deferred"
sudo docker logs for_health_postfix 2> | grep -c "status=bounced"
```

### 2. 实时状态监控

```bash
# 创建一个简单的监控脚本
cat > mail-monitor.sh << 'EOF'
#!/bin/bash
echo "📮 Postfix 邮件状态监控"
echo "========================"
echo "当前时间: $(date)"
echo

echo "1. 邮件队列数量:"
docker exec for_health_postfix postqueue -p | tail -1
echo

echo "2. 最近发送状态:"
docker logs for_health_postfix --tail 10 2> | grep "status=" | tail -5
echo

echo "3. 容器状态:"
docker ps | grep -E "postfix|backend"
echo

echo "4. 端口监听:"
sudo netstat -tlnp | grep -E ":25|:1025" 2> || echo "需要 sudo 权限查看"
echo

echo "📋 查看完整日志: docker logs for_health_postfix -f"
echo "🧹 清空队列: docker exec for_health_postfix postsuper -d ALL"
echo "🔍 查看队列: docker exec for_health_postfix postqueue -p"
EOF

chmod +x mail-monitor.sh

# 使用监控脚本
./mail-monitor.sh
```

---

## 🔧 高级管理

### 邮件队列管理 API（可以集成到应用）

在我们的后端项目中，可以添加邮件管理 API 端点：

```bash
# 查看邮件队列状态（需要后端添加此API）
curl -X GET http://124.70.161.90:8000/api/admin/mail/queue-status

# 重试发送失败邮件
curl -X POST http://124.70.161.90:8000/api/admin/mail/retry-queue

# 清空队列（需要管理员权限）
curl -X POST http://124.70.161.90:8000/api/admin/mail/clear-queue \
  -H "Authorization: Bearer 你的管理员token"
```

### 实现效果良好的监控面板

```python
# 推荐后端的邮件状态端点（app/routers/admin.py）
# 只给管理员使用的接口

@router.get("/mail/status")
async def get_mail_status(current_user: User = Security(get_current_admin_user)):
    """获取邮件系统状态"""
    try:
        result = subprocess.run([
            'docker', 'exec', 'for_health_postfix',
            'postqueue', '-j'
        ], capture_output=True, text=True)

        queue_data = json.loads(result.stdout)

        return {
            "queue_length": len(queue_data),
            "sent_today": get_sent_count_today(),
            "failed_today": get_failed_count_today(),
            "last_sent": get_last_sent_time(),
            "queue_details": queue_data
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"邮件状态查询失败: {e}")
```

---

## 🔧 命令行工具速查表

### 邮件队列操作
```bash
# 📊 查看队列
sudo docker exec for_health_postfix postqueue -p

# 🔁 重试所有队列邮件
sudo docker exec for_health_postfix postqueue -f

# 🗑️ 删除特定队列（替换ID）
sudo docker exec for_health_postfix postsuper -d ALL

# 🔍 查看特定邮件详情
sudo docker exec for_health_postfix find /var/spool/postfix -name "*邮件ID*" -exec cat {} \;
```

### 日志查看
```bash
# 📃 实时日志
sudo docker logs for_health_postfix -f

# 📊 统计日志
echo "邮件发送统计："
sudo docker logs for_health_postfix 2> | grep "status=sent" | wc -l
echo "失败邮件："
sudo docker logs for_health_postfix 2> | grep "status=bounced" | wc -l
```

---

## 🎯 Web 管理界面访问地址

| 界面 | 地址 | 说明 |
|------|------|------|
| MailHog 邮件查看 | http://124.70.161.90:8025 | 查看所有发送的邮件 |
| MailCatcher 队列 | http://124.70.161.90:8027 | *需要手动运行命令* |
| PostfixAdmin | http://124.70.161.90:8026 | 邮箱用户管理 |

---

## 📝 总结

**当前配置：**
- ✅ MailHog Web 界面 `http://ip:8025`：查看实时发送的邮件
- ✅ Postfix WebAdmin `http://ip:8026`：虚拟邮箱管理（可选）
- ⚠️ 实际 Postfix 队列管理：使用命令行工具（最可靠）

**推荐使用方法：**
1. **调试邮件内容** → 访问 MailHog:8025
2. **查看邮件队列** → 使用 `postqueue -p` 命令
3. **监控实时发送** → 使用 `docker logs -f`
4. **统计发送情况** → 使用监控脚本

这样的配置既提供了可视化的 Web 界面，又不影响实际的邮件发送功能。Web 界面主要用于调试和监控，核心管理能力仍通过 Docker 命令完成。