# 后端本地测试说明

#### 步骤 1: 用户注册

```bash
curl -X POST "http://localhost:8000/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "username": "测试用户",
    "password": "password123"
  }'
```

预期响应 (201):
```json
{
  "message": "注册成功，请继续填写身体基本数据",
  "data": {
    "email": "test@example.com",
    "username": "测试用户"
  }
}
```

#### 步骤 2: 用户登录

```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'
```

预期响应 (200):
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**保存 access_token，后续请求需要使用！**

#### 步骤 3: 填写身体基本数据

```bash
curl -X POST "http://localhost:8000/api/user/body-data" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "height": 175.0,
    "weight": 70.0,
    "age": 25,
    "gender": "male"
  }'
```

预期响应 (200):
```json
{
  "message": "身体数据更新成功",
  "data": {
    "bmr": 1680.75
  }
}
```

#### 步骤 4: 选择活动水平

```bash
curl -X POST "http://localhost:8000/api/user/activity-level" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "activity_level": "moderately_active"
  }'
```

预期响应 (200):
```json
{
  "message": "活动水平更新成功",
  "data": {
    "activity_level": "moderately_active",
    "tdee": 2605.16
  }
}
```

#### 步骤 5: 设定健康目标

```bash
curl -X POST "http://localhost:8000/api/user/health-goal" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "health_goal_type": "lose_weight",
    "target_weight": 65.0,
    "goal_period_weeks": 10
  }'
```

预期响应 (200):
```json
{
  "message": "健康目标设定成功",
  "data": {
    "health_goal_type": "lose_weight",
    "daily_calorie_goal": 2105.16
  }
}
```

#### 步骤 6: 获取完整资料

```bash
curl -X GET "http://localhost:8000/api/user/profile" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

预期响应 (200):
```json
{
  "email": "test@example.com",
  "username": "测试用户",
  "height": 175.0,
  "weight": 70.0,
  "age": 25,
  "gender": "male",
  "activity_level": "moderately_active",
  "health_goal_type": "lose_weight",
  "target_weight": 65.0,
  "goal_period_weeks": 10,
  "bmr": 1680.75,
  "tdee": 2605.16,
  "daily_calorie_goal": 2105.16
}
```

#### 步骤 7: 更新用户资料

```bash
curl -X PUT "http://localhost:8000/api/user/profile" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "weight": 68.0
  }'
```

预期响应 (200):
```json
{
  "email": "test@example.com",
  "username": "测试用户",
  "height": 175.0,
  "weight": 68.0,
  "age": 25,
  "gender": "male",
  "activity_level": "moderately_active",
  "health_goal_type": "lose_weight",
  "target_weight": 65.0,
  "goal_period_weeks": 10,
  "bmr": 1660.75,
  "tdee": 2574.16,
  "daily_calorie_goal": 2074.16
}
```

### 4. 测试密码重置（需要配置 SMTP）

#### 发送验证码

```bash
curl -X POST "http://localhost:8000/api/auth/password-reset/send-code" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com"
  }'
```

#### 重置密码

```bash
curl -X POST "http://localhost:8000/api/auth/password-reset/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "verification_code": "123456",
    "new_password": "newpassword123",
    "confirm_password": "newpassword123"
  }'
```

## 运行单元测试

```bash
cd backend
pytest tests/ -v
```

## 常见问题

### 1. MongoDB 连接失败

**错误**: `ConnectionError: Cannot connect to MongoDB`

**解决**:
- 确保 MongoDB 服务正在运行
- 检查 `.env` 中的 `MONGODB_URL` 配置
- 如果使用 Docker: `docker ps` 检查容器是否运行

### 2. 依赖安装失败

**错误**: `pip install` 失败

**解决**:
```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### 3. 端口被占用

**错误**: `Address already in use`

**解决**:
- 修改 `.env` 中的 `PORT` 配置
- 或杀死占用 8000 端口的进程

### 4. JWT Token 无效

**错误**: `无效的认证凭证`

**解决**:
- Token 可能已过期（默认30分钟），重新登录获取新 Token
- 确保 Header 格式正确: `Authorization: Bearer <token>`

## 数据验证测试

### 测试参数验证

#### 身高超出范围（应失败）

```bash
curl -X POST "http://localhost:8000/api/user/body-data" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -d '{
    "height": 300.0,
    "weight": 70.0,
    "age": 25,
    "gender": "male"
  }'
```

预期响应 (422):
```json
{
  "detail": [
    {
      "loc": ["body", "height"],
      "msg": "ensure this value is less than or equal to 250",
      "type": "value_error.number.not_le"
    }
  ]
}
```

#### 密码过短（应失败）

```bash
curl -X POST "http://localhost:8000/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test2@example.com",
    "username": "用户2",
    "password": "123"
  }'
```

预期响应 (422):
```json
{
  "detail": [
    {
      "loc": ["body", "password"],
      "msg": "ensure this value has at least 6 characters",
      "type": "value_error.any_str.min_length"
    }
  ]
}
```

## 测试检查清单

- [x] 服务启动成功
- [x] 健康检查接口正常
- [x] 用户注册功能正常
- [x] 用户登录功能正常，能获取 Token
- [x] 身体基本数据更新正常，BMR 计算正确
- [x] 活动水平更新正常，TDEE 计算正确
- [x] 健康目标设定正常，每日卡路里目标计算正确
- [x] 用户资料获取正常
- [x] 用户资料更新正常，相关数值自动重新计算
- [ ] 密码重置功能正常（需配置 SMTP）
- [x] 参数验证正常，错误提示清晰
- [x] JWT 认证正常，未认证请求被拒绝
