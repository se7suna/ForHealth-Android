# åä¸ºäº‘æœåŠ¡å™¨éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æœåŠ¡å™¨é…ç½®æ¨è](#ä¸€æœåŠ¡å™¨é…ç½®æ¨è)
- [äºŒã€éƒ¨ç½²æ¶æ„è®¾è®¡](#äºŒéƒ¨ç½²æ¶æ„è®¾è®¡)
- [ä¸‰ã€CI/CD è‡ªåŠ¨éƒ¨ç½²æµç¨‹](#ä¸‰cicd-è‡ªåŠ¨éƒ¨ç½²æµç¨‹)
- [å››ã€GitLab Runner éƒ¨ç½²æ–¹æ¡ˆ](#å››gitlab-runner-éƒ¨ç½²æ–¹æ¡ˆ)
- [äº”ã€è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#äº”è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
- [å…­ã€éªŒè¯å’Œæµ‹è¯•](#å…­éªŒè¯å’Œæµ‹è¯•)
- [ä¸ƒã€å¸¸ç”¨è¿ç»´å‘½ä»¤](#ä¸ƒå¸¸ç”¨è¿ç»´å‘½ä»¤)
- [å…«ã€æ•…éšœæ’æŸ¥](#å…«æ•…éšœæ’æŸ¥)
- [ä¹ã€æˆæœ¬ä¼°ç®—](#ä¹æˆæœ¬ä¼°ç®—)

---

## ä¸€ã€æœåŠ¡å™¨é…ç½®æ¨è

### ğŸ–¥ï¸ æ¨èé…ç½®æ–¹æ¡ˆ

#### æ–¹æ¡ˆä¸€ï¼šç»æµå‹ï¼ˆé€‚åˆå°å›¢é˜Ÿå¼€å‘æµ‹è¯•ï¼‰

- **è§„æ ¼**: é€šç”¨è®¡ç®—å‹ S6
- **é…ç½®**: 2æ ¸ 4GBï¼ˆs6.large.2ï¼‰
- **ç³»ç»Ÿç›˜**: 40GB é«˜IO
- **æ•°æ®ç›˜**: 50GB é«˜IOï¼ˆå­˜å‚¨æ•°æ®åº“å’Œæ—¥å¿—ï¼‰
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS Server 64bit
- **å¸¦å®½**: 5Mbps æŒ‰éœ€è®¡è´¹æˆ–åŒ…å¹´åŒ…æœˆ
- **é¢„ä¼°è´¹ç”¨**: Â¥150-200/æœˆ

#### æ–¹æ¡ˆäºŒï¼šæ ‡å‡†å‹ï¼ˆæ¨èï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰â­

- **è§„æ ¼**: é€šç”¨è®¡ç®—å‹ S6
- **é…ç½®**: 4æ ¸ 8GBï¼ˆs6.xlarge.2ï¼‰
- **ç³»ç»Ÿç›˜**: 40GB è¶…é«˜IO SSD
- **æ•°æ®ç›˜**: 100GB è¶…é«˜IO SSD
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS Server 64bit
- **å¸¦å®½**: 10Mbps
- **é¢„ä¼°è´¹ç”¨**: Â¥350-450/æœˆ

#### æ–¹æ¡ˆä¸‰ï¼šé«˜æ€§èƒ½å‹ï¼ˆå¤šäººå›¢é˜Ÿé¢‘ç¹æ„å»ºï¼‰

- **è§„æ ¼**: é€šç”¨è®¡ç®—å‹ S6
- **é…ç½®**: 8æ ¸ 16GBï¼ˆs6.2xlarge.2ï¼‰
- **ç³»ç»Ÿç›˜**: 40GB è¶…é«˜IO SSD
- **æ•°æ®ç›˜**: 200GB è¶…é«˜IO SSD
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS Server 64bit
- **å¸¦å®½**: 20Mbps
- **é¢„ä¼°è´¹ç”¨**: Â¥700-850/æœˆ

### ğŸ’¡ æ¨èç†ç”±

åŸºäºé¡¹ç›®æŠ€æœ¯æ ˆåˆ†æï¼š

- **FastAPI + MongoDB** åç«¯æ¶æ„
- **GitLab Runner** éœ€è¦è¿è¡Œ Docker å®¹å™¨
- **CI/CD æµæ°´çº¿** éœ€è¦åŒæ—¶è¿è¡Œå¤šä¸ªæœåŠ¡ï¼ˆMongoDB, MailHogï¼‰
- **å›¢é˜Ÿåä½œ** éœ€è¦ç¨³å®šçš„æ„å»ºç¯å¢ƒ

**æ¨èé€‰æ‹©æ–¹æ¡ˆäºŒï¼ˆ4æ ¸8GBï¼‰**ï¼Œç†ç”±ï¼š

1. âœ… è¶³å¤Ÿè¿è¡Œ FastAPI + MongoDB + GitLab Runner + Docker
2. âœ… å¯ä»¥åŒæ—¶è·‘ 2-3 ä¸ª CI/CD ä»»åŠ¡
3. âœ… æ€§ä»·æ¯”é«˜ï¼Œæ»¡è¶³ç”Ÿäº§ç¯å¢ƒéœ€æ±‚
4. âœ… é¢„ç•™æ‰©å±•ç©ºé—´

---

## äºŒã€éƒ¨ç½²æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åä¸ºäº‘æœåŠ¡å™¨ (Ubuntu 22.04)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  GitLab Runner (Docker Executor)                â”‚    â”‚
â”‚  â”‚  - ç›‘å¬ GitLab ä»“åº“                              â”‚    â”‚
â”‚  â”‚  - è‡ªåŠ¨æ‰§è¡Œ CI/CD Pipeline                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç”Ÿäº§ç¯å¢ƒ (Docker Compose)                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚ FastAPI App  â”‚  â”‚   MongoDB    â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  (Uvicorn)   â”‚  â”‚   Database   â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  Port: 8000  â”‚  â”‚  Port: 27017 â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚    Nginx     â”‚  â”‚   MailHog    â”‚            â”‚    â”‚
â”‚  â”‚  â”‚  Port: 80/443â”‚  â”‚ Port: 1025   â”‚            â”‚    â”‚
â”‚  â”‚  â”‚              â”‚  â”‚ Web: 8025    â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç›‘æ§ & æ—¥å¿—                                      â”‚    â”‚
â”‚  â”‚  - Docker logs                                   â”‚    â”‚
â”‚  â”‚  - GitLab Runner logs                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘                           â†“
    GitLab Webhook          è‡ªåŠ¨æ‹‰å–ä»£ç éƒ¨ç½²
    (main åˆ†æ”¯å˜æ›´)
```

---

## ä¸‰ã€CI/CD è‡ªåŠ¨éƒ¨ç½²æµç¨‹

### å·¥ä½œæµç¨‹

```
1. å¼€å‘è€…æ¨é€ä»£ç åˆ° main åˆ†æ”¯
   â†“
2. GitLab è§¦å‘ Webhook
   â†“
3. æœåŠ¡å™¨ä¸Šçš„ GitLab Runner è‡ªåŠ¨æ‰§è¡Œ Pipeline:
   - test é˜¶æ®µï¼šå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•
   - build é˜¶æ®µï¼šæ„å»ºåº”ç”¨
   - deploy é˜¶æ®µï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ â­
   â†“
4. éƒ¨ç½²æˆåŠŸåè‡ªåŠ¨é‡å¯æœåŠ¡
```

### æ›´æ–° .gitlab-ci.ymlï¼ˆæ–°å¢éƒ¨ç½²é˜¶æ®µï¼‰

åœ¨ç°æœ‰çš„ `.gitlab-ci.yml` æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```yaml
# ==================== Deploy Stage ====================

deploy:production:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER_IP >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - |
      ssh $DEPLOY_USER@$DEPLOY_SERVER_IP << 'ENDSSH'
        cd /opt/for_health
        git pull origin main
        docker-compose -f docker-compose.prod.yml down
        docker-compose -f docker-compose.prod.yml up -d --build
        docker-compose -f docker-compose.prod.yml ps
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
      ENDSSH
  only:
    - main
  when: manual  # æ‰‹åŠ¨è§¦å‘ï¼Œç¡®ä¿å®‰å…¨
  tags:
    - docker
  environment:
    name: production
    url: http://124.70.161.90:8000
```

---

## å››ã€GitLab Runner éƒ¨ç½²æ–¹æ¡ˆ

### Runner é…ç½®ç‰¹ç‚¹

- **ç±»å‹**: Shared Runnerï¼ˆå›¢é˜Ÿå…±äº«ï¼‰
- **æ‰§è¡Œå™¨**: Docker Executor
- **å¹¶å‘**: 2-3 ä¸ªä»»åŠ¡ï¼ˆæ ¹æ®æœåŠ¡å™¨é…ç½®ï¼‰
- **æ ‡ç­¾**: `docker`, `production`
- **ç‰¹æƒæ¨¡å¼**: å¼€å¯ï¼ˆæ”¯æŒ Docker-in-Dockerï¼‰

### Runner ä¼˜åŠ¿

1. âœ… **å›¢é˜Ÿå…±äº«**ï¼šæ‰€æœ‰ç»„å‘˜éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ª Runner
2. âœ… **éš”ç¦»ç¯å¢ƒ**ï¼šæ¯æ¬¡æ„å»ºéƒ½æ˜¯å…¨æ–°çš„ Docker å®¹å™¨
3. âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šæ„å»ºå®Œæˆåè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
4. âœ… **ç¨³å®šå¯æ§**ï¼šè‡ªå»º Runnerï¼Œä¸å— GitLab.com é™åˆ¶

---

## äº”ã€è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šè´­ä¹°å’Œåˆå§‹åŒ–æœåŠ¡å™¨

#### 1. åœ¨åä¸ºäº‘æ§åˆ¶å°è´­ä¹° ECS æœåŠ¡å™¨

- **åŒºåŸŸ**ï¼šé€‰æ‹©ç¦»æ‚¨æœ€è¿‘çš„åŒºåŸŸï¼ˆå¦‚åå—-å¹¿å·ï¼‰
- **è§„æ ¼**ï¼šé€šç”¨è®¡ç®—å‹ S6 4æ ¸8GB
- **é•œåƒ**ï¼šUbuntu 22.04 LTS Server 64bit
- **ç½‘ç»œ**ï¼šVPC é»˜è®¤é…ç½®
- **å®‰å…¨ç»„**ï¼šå¼€æ”¾ç«¯å£ 22, 80, 443, 8000, 8025
- **ç™»å½•æ–¹å¼**ï¼šå¯†é’¥å¯¹ï¼ˆæ›´å®‰å…¨ï¼‰æˆ–å¯†ç 

**ç«¯å£è¯´æ˜ï¼š**
- 22: SSH ç™»å½•
- 80/443: HTTP/HTTPSï¼ˆNginxï¼‰
- 8000: FastAPI åç«¯
- 8025: MailHog Web UIï¼ˆæŸ¥çœ‹é‚®ä»¶ï¼‰

#### 2. ç™»å½•æœåŠ¡å™¨

```bash
ssh root@your_server_ip
```

#### 3. ç³»ç»Ÿæ›´æ–°

```bash
apt update && apt upgrade -y
```

#### 4. è®¾ç½®æ—¶åŒº

```bash
timedatectl set-timezone Asia/Shanghai
```

#### 5. åˆ›å»ºéƒ¨ç½²ç”¨æˆ·

```bash
useradd -m -s /bin/bash deploy
usermod -aG sudo deploy
echo "deploy ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
```

---

### ç¬¬äºŒæ­¥ï¼šå®‰è£…åŸºç¡€ç¯å¢ƒ

#### 1. åˆ‡æ¢åˆ° deploy ç”¨æˆ·

```bash
su - deploy
```

#### 2. å®‰è£… Docker

```bash
# ä¸‹è½½å®‰è£…è„šæœ¬
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å°†å½“å‰ç”¨æˆ·åŠ å…¥ docker ç»„
sudo usermod -aG docker deploy

# é‡æ–°ç™»å½•ä½¿ docker ç»„ç”Ÿæ•ˆ
exit
su - deploy

# éªŒè¯ Docker å®‰è£…
docker --version
docker run hello-world
```

#### 3. å®‰è£… Docker Compose

```bash
# 1. æ›´æ–°ç´¢å¼•
sudo apt update

# 2. å®‰è£… compose æ’ä»¶ï¼ˆæ³¨æ„æ˜¯â€œdocker-compose-pluginâ€ï¼‰
sudo apt install -y docker-compose-plugin

# 3. éªŒè¯ï¼ˆæ³¨æ„å‘½ä»¤æ˜¯ docker composeï¼Œä¸­é—´æœ‰ç©ºæ ¼ï¼‰
docker compose version
```

#### 4. å®‰è£… Git

```bash
sudo apt install -y git
```

#### 5. é…ç½® Docker é•œåƒåŠ é€Ÿ

```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://dockerproxy.com",
    "https://docker.m.daocloud.io",
    "https://hub-mirror.c.163.com"
  ],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
EOF

sudo systemctl daemon-reload
sudo systemctl restart docker
```

---

### ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½² GitLab Runner

#### 1. ä¸‹è½½ GitLab Runner

```bash
#å¤‡ä»½åŸæœ‰æºåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰

sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
#æ·»åŠ æ¸…åæº
 /etc/apt/sources.list æˆ–ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿½åŠ ï¼š
echo "deb https://mirrors.tuna.tsinghua.edu.cn/gitlab-runner/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/gitlab-runner.list
#æ·»åŠ  GPG å…¬é’¥
curl -fsSL https://packages.gitlab.com/gpg.key | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/gitlab-runner.gpg
æ›´æ–°å¹¶å®‰è£…
sudo apt update
sudo apt install gitlab-runner
```

#### 2. éªŒè¯å®‰è£…

      
```bash
gitlab-runner --version
```

#### 3. æ³¨å†Œ Runner

é¦–å…ˆåœ¨ GitLab é¡¹ç›®ä¸­è·å– Registration Tokenï¼š

- é¡¹ç›® â†’ Settings â†’ CI/CD â†’ Runners â†’ Expand â†’ Registration token

```bash
sudo gitlab-runner register

# æŒ‰æç¤ºè¾“å…¥ï¼š
# GitLab URL: https://gitlab.com/
# Registration token: [ä» GitLab é¡¹ç›®è·å–]
# Description: for-health-production-runner
# Tags: docker,production
# Executor: docker
# Default Docker image: python:3.11
```

#### 4. é…ç½® Runner

ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
sudo nano /etc/gitlab-runner/config.toml
```

ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```toml
concurrent = 2  # å…è®¸å¹¶å‘æ‰§è¡Œ 2 ä¸ªä»»åŠ¡

[[runners]]
  name = "for-health-production-runner"
  url = "https://gitlab.com/"
  token = "YOUR_RUNNER_TOKEN"
  executor = "docker"

  [runners.docker]
    tls_verify = false
    image = "python:3.11"
    privileged = true  # å…è®¸ Docker-in-Docker
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/cache", "/var/run/docker.sock:/var/run/docker.sock"]
    shm_size = 0
    pull_policy = "if-not-present"

  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]
```

#### 5. é‡å¯ Runner

```bash
sudo gitlab-runner restart
```

#### 6. éªŒè¯ Runner çŠ¶æ€

```bash
sudo gitlab-runner status
sudo gitlab-runner list
```

#### 7. åœ¨ GitLab é¡¹ç›®ä¸­éªŒè¯

- é¡¹ç›® â†’ Settings â†’ CI/CD â†’ Runners
- åº”è¯¥çœ‹åˆ°ç»¿è‰²çš„ Runner

---

### ç¬¬å››æ­¥ï¼šéƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ

#### 1. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
sudo mkdir -p /opt/for_health
sudo chown deploy:deploy /opt/for_health
cd /opt/for_health
```

#### 2. å…‹éš†é¡¹ç›®ä»£ç 

```bash
# ä½¿ç”¨ HTTPSï¼ˆéœ€è¦è¾“å…¥ç”¨æˆ·åå’Œå¯†ç /tokenï¼‰
git clone https://gitlab.com/your-group/for_health.git .

# æˆ–ä½¿ç”¨ Deploy Tokenï¼ˆæ›´å®‰å…¨ï¼Œæ¨èï¼‰
# GitLab: é¡¹ç›® -> Settings -> Repository -> Deploy Tokens
# åˆ›å»ºä¸€ä¸ªåªè¯»çš„ Deploy Token
git clone https://gitlab-deploy-token:YOUR_TOKEN@gitlab.com/your-group/for_health.git .
```

#### 3. åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶

```bash
cd /opt/for_health
nano .env.production
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```bash
# æ•°æ®åº“é…ç½®
MONGODB_URL=mongodb://mongodb:27017
DATABASE_NAME=for_health_prod

# å®‰å…¨é…ç½®
SECRET_KEY=your-super-secret-key-change-this-in-production-min-32-chars
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# é‚®ä»¶é…ç½®ï¼ˆä½¿ç”¨ MailHog é‚®ä»¶æœåŠ¡å™¨ï¼‰â­
SMTP_HOST=mailhog
SMTP_PORT=1025
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=noreply@forhealth.com
SMTP_FROM_NAME=For Health

# åº”ç”¨é…ç½®
DEBUG=False
```

**ğŸ“§ é‚®ä»¶æœåŠ¡å™¨è¯´æ˜ï¼š**

- **å½“å‰é…ç½®**ï¼šä½¿ç”¨ MailHogï¼ˆæ¨èç”¨äºæµ‹è¯•/æ¼”ç¤ºç¯å¢ƒï¼‰
  - âœ… æ— éœ€é…ç½®çœŸå®é‚®ä»¶æœåŠ¡å™¨
  - âœ… æä¾› Web ç•Œé¢æŸ¥çœ‹é‚®ä»¶ï¼š`http://æœåŠ¡å™¨IP:8025`
  - âœ… éƒ¨ç½²ç®€å•ï¼Œå¼€ç®±å³ç”¨

- **å¦‚éœ€åˆ‡æ¢åˆ°çœŸå®é‚®ä»¶æœåŠ¡å™¨**ï¼ˆæ­£å¼ä¸Šçº¿æ—¶ä½¿ç”¨ï¼‰ï¼š
  ```bash
  # Gmail é…ç½®ç¤ºä¾‹
  SMTP_HOST=smtp.gmail.com
  SMTP_PORT=587
  SMTP_USER=your-email@gmail.com
  SMTP_PASSWORD=your-app-password

  # QQ é‚®ç®±é…ç½®ç¤ºä¾‹
  SMTP_HOST=smtp.qq.com
  SMTP_PORT=587
  SMTP_USER=your-qq-email@qq.com
  SMTP_PASSWORD=your-authorization-code

  # 163 é‚®ç®±é…ç½®ç¤ºä¾‹
  SMTP_HOST=smtp.163.com
  SMTP_PORT=465
  SMTP_USER=your-163-email@163.com
  SMTP_PASSWORD=your-authorization-code
  ```

#### 4. åˆ›å»ºç”Ÿäº§ç¯å¢ƒ docker-compose æ–‡ä»¶

```bash
nano docker-compose.prod.yml
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```yaml
version: '3.8'

services:
  # FastAPI åç«¯åº”ç”¨
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: for_health_backend
    restart: always
    ports:
      - "8000:8000"
    env_file:
      - .env.production
    depends_on:
      - mongodb
      - mailhog
    networks:
      - for_health_network
    volumes:
      - ./backend/app:/app/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB æ•°æ®åº“
  mongodb:
    image: mongo:latest
    container_name: for_health_mongodb
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - ./backup:/backup  # å¤‡ä»½ç›®å½•
    networks:
      - for_health_network
    environment:
      MONGO_INITDB_DATABASE: for_health_prod

  # MailHog é‚®ä»¶æœåŠ¡å™¨
  mailhog:
    image: axllent/mailpit:latest
    container_name: for_health_mailhog
    restart: always
    ports:
      - "1025:1025"  # SMTP ç«¯å£
      - "8025:8025"  # Web UI ç«¯å£
    networks:
      - for_health_network
    environment:
      MP_SMTP_BIND_ADDR: 0.0.0.0:1025
      MP_UI_BIND_ADDR: 0.0.0.0:8025

  # Nginx åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰
  nginx:
    image: nginx:alpine
    container_name: for_health_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - for_health_network

volumes:
  mongodb_data:
    driver: local

networks:
  for_health_network:
    driver: bridge
```

#### 5. åˆ›å»º Dockerfile

```bash
nano backend/Dockerfile
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "4"]
```

#### 6. åˆ›å»º Nginx é…ç½®

```bash
mkdir -p nginx
nano nginx/nginx.conf
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```nginx
events {
    worker_connections 1024;
}

http {
    upstream backend {
        server backend:8000;
    }

    server {
        listen 80;
        server_name your-domain.com;  # æ›¿æ¢ä¸ºæ‚¨çš„åŸŸåæˆ– IP

        client_max_body_size 10M;

        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket æ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /health {
            access_log off;
            proxy_pass http://backend/health;
        }
    }
}
```

#### 7. æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹åˆ°åç«¯

ç¼–è¾‘ `backend/app/main.py`ï¼Œæ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š

```python
from datetime import datetime

@app.get("/health")
async def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "service": "for_health_backend"
    }
```

#### 8. å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

```bash
cd /opt/for_health
docker-compose -f docker-compose.yml up -d
```

#### 9. æŸ¥çœ‹æ—¥å¿—

```bash
docker-compose -f docker-compose.yml logs -f
```

#### 10. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8000/health

# è®¿é—® API æ–‡æ¡£
curl http://localhost:8000/docs
```

---

### ç¬¬äº”æ­¥ï¼šé…ç½®è‡ªåŠ¨éƒ¨ç½²

#### 1. ç”Ÿæˆ SSH å¯†é’¥

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
ssh-keygen -t rsa -b 4096 -C "gitlab-ci@forhealth" -f ~/.ssh/gitlab_deploy_key
```

#### 2. æ·»åŠ å…¬é’¥åˆ°æœåŠ¡å™¨

```bash
cat ~/.ssh/gitlab_deploy_key.pub >> ~/.ssh/authorized_keys
```

#### 3. å°†ç§é’¥æ·»åŠ åˆ° GitLab CI/CD å˜é‡

```bash
# æŸ¥çœ‹ç§é’¥å†…å®¹
cat ~/.ssh/gitlab_deploy_key
```

åœ¨ GitLab é¡¹ç›®ä¸­æ·»åŠ  CI/CD å˜é‡ï¼š

- é¡¹ç›® â†’ Settings â†’ CI/CD â†’ Variables â†’ Add Variable
- **Key**: `SSH_PRIVATE_KEY`
- **Value**: [ç²˜è´´ç§é’¥å†…å®¹]
- **Type**: File
- **Protected**: Yes
- **Masked**: No

#### 4. æ·»åŠ å…¶ä»– CI/CD å˜é‡

åœ¨ GitLab é¡¹ç›®ä¸­æ·»åŠ ä»¥ä¸‹å˜é‡ï¼š

| Key | Value | Type | Protected |
|-----|-------|------|-----------|
| `DEPLOY_SERVER_IP` | æ‚¨çš„æœåŠ¡å™¨ IP | Variable | Yes |
| `DEPLOY_USER` | deploy | Variable | Yes |

#### 5. åˆ›å»ºéƒ¨ç½²è„šæœ¬

```bash
nano /opt/for_health/deploy.sh
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash
set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½² For Health åç«¯..."

# æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
git pull origin main

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
echo "ğŸ—ï¸ æ„å»º Docker é•œåƒ..."
docker-compose -f docker-compose.prod.yml build --no-cache

echo "ğŸ”„ é‡å¯æœåŠ¡..."
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 10

# å¥åº·æ£€æŸ¥
echo "ğŸ¥ å¥åº·æ£€æŸ¥..."
if curl -f http://localhost:8000/health; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡è¿è¡Œæ­£å¸¸ã€‚"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼æœåŠ¡å¥åº·æ£€æŸ¥æœªé€šè¿‡ã€‚"
    docker-compose -f docker-compose.prod.yml logs backend
    exit 1
fi

# æ¸…ç†æ—§é•œåƒ
echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
docker image prune -f

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
```

èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

```bash
chmod +x /opt/for_health/deploy.sh
```

#### 6. æ›´æ–° .gitlab-ci.yml

åœ¨é¡¹ç›®çš„ `.gitlab-ci.yml` æ–‡ä»¶ä¸­æ·»åŠ  `deploy` é˜¶æ®µï¼ˆå‚è§ç¬¬ä¸‰ç« ï¼‰ã€‚

---

### ç¬¬å…­æ­¥ï¼šé…ç½®ç›‘æ§å’Œæ—¥å¿—

#### 1. åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
sudo mkdir -p /var/log/for_health
sudo chown deploy:deploy /var/log/for_health
```

#### 2. åˆ›å»ºç›‘æ§è„šæœ¬

```bash
nano /opt/for_health/monitor.sh
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "=== Docker å®¹å™¨çŠ¶æ€ ==="
docker-compose -f /opt/for_health/docker-compose.prod.yml ps

echo -e "\n=== åç«¯æœåŠ¡å¥åº·æ£€æŸ¥ ==="
curl -s http://localhost:8000/health | python3 -m json.tool

echo -e "\n=== ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
df -h | grep -E '^/dev/'

echo -e "\n=== å†…å­˜ä½¿ç”¨æƒ…å†µ ==="
free -h

echo -e "\n=== Docker é•œåƒå¤§å° ==="
docker system df

echo -e "\n=== æœ€è¿‘çš„å®¹å™¨æ—¥å¿— ==="
docker-compose -f /opt/for_health/docker-compose.prod.yml logs --tail=50 backend
```

èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

```bash
chmod +x /opt/for_health/monitor.sh
```

#### 3. è®¾ç½®å®šæ—¶ç›‘æ§ï¼ˆå¯é€‰ï¼‰

```bash
crontab -e
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰ï¼š

```bash
0 * * * * /opt/for_health/monitor.sh >> /var/log/for_health/monitor.log 2>&1
```

---

### ç¬¬ä¸ƒæ­¥ï¼šé…ç½®å¤‡ä»½

#### 1. åˆ›å»ºå¤‡ä»½è„šæœ¬

```bash
nano /opt/for_health/backup.sh
```

å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash
set -e

BACKUP_DIR="/opt/for_health/backup"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="mongodb_backup_${DATE}.tar.gz"

echo "ğŸ—„ï¸ å¼€å§‹å¤‡ä»½ MongoDB æ•°æ®åº“..."

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½ MongoDB
docker exec for_health_mongodb mongodump \
    --out /backup/dump_${DATE} \
    --db for_health_prod

# å‹ç¼©å¤‡ä»½
cd $BACKUP_DIR
tar -czf $BACKUP_FILE dump_${DATE}
rm -rf dump_${DATE}

echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_FILE"

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "mongodb_backup_*.tar.gz" -mtime +7 -delete

echo "ğŸ§¹ æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½"
```

èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

```bash
chmod +x /opt/for_health/backup.sh
```

#### 2. è®¾ç½®å®šæ—¶å¤‡ä»½

```bash
crontab -e
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰ï¼š

```bash
0 2 * * * /opt/for_health/backup.sh >> /var/log/for_health/backup.log 2>&1
```

---

### ç¬¬å…«æ­¥ï¼šå®‰å…¨åŠ å›º

#### 1. é…ç½®é˜²ç«å¢™

```bash
sudo ufw enable
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 8025/tcp  # MailHog Web UI
sudo ufw status
```

#### 2. é…ç½® fail2banï¼ˆé˜²æ­¢æš´åŠ›ç ´è§£ï¼‰

```bash
sudo apt install -y fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

#### 3. ç¦ç”¨ root SSH ç™»å½•

```bash
sudo nano /etc/ssh/sshd_config
```

æ‰¾åˆ°å¹¶ä¿®æ”¹ä»¥ä¸‹è¡Œï¼š

```
PermitRootLogin no
```

é‡å¯ SSH æœåŠ¡ï¼š

```bash
sudo systemctl restart sshd
```

#### 4. è®¾ç½®è‡ªåŠ¨å®‰å…¨æ›´æ–°

```bash
sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

## å…­ã€éªŒè¯å’Œæµ‹è¯•

### 1. éªŒè¯ GitLab Runner

åœ¨ GitLab é¡¹ç›®ä¸­æäº¤ä»£ç ï¼Œè§¦å‘ Pipelineï¼š

```bash
git add .
git commit -m "test: æµ‹è¯• CI/CD Pipeline"
git push origin feature-test
```

### 2. éªŒè¯è‡ªåŠ¨éƒ¨ç½²

åˆå¹¶åˆ° main åˆ†æ”¯ï¼Œåœ¨ GitLab Pipeline é¡µé¢æ‰‹åŠ¨è§¦å‘ `deploy:production` ä»»åŠ¡ã€‚

### 3. éªŒè¯ç”Ÿäº§ç¯å¢ƒ

```bash
# å¥åº·æ£€æŸ¥
curl http://your-server-ip:8000/health

# API æ–‡æ¡£
curl http://your-server-ip:8000/docs

# MailHog Web UIï¼ˆæŸ¥çœ‹é‚®ä»¶ï¼‰
# åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼šhttp://your-server-ip:8025
```

### 4. éªŒè¯ Runner æ—¥å¿—

```bash
sudo gitlab-runner --debug run
```

### 5. æŸ¥çœ‹ Docker æ—¥å¿—

```bash
docker-compose -f docker-compose.prod.yml logs -f
```

---

## ä¸ƒã€å¸¸ç”¨è¿ç»´å‘½ä»¤

### æœåŠ¡ç®¡ç†

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker ps -a

# é‡å¯æ‰€æœ‰æœåŠ¡
cd /opt/for_health
docker-compose -f docker-compose.prod.yml restart

# é‡å¯å•ä¸ªæœåŠ¡
docker-compose -f docker-compose.prod.yml restart backend

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
```

### GitLab Runner ç®¡ç†

```bash
# æŸ¥çœ‹ Runner çŠ¶æ€
sudo gitlab-runner status

# é‡å¯ Runner
sudo gitlab-runner restart

# æŸ¥çœ‹ Runner æ—¥å¿—
sudo journalctl -u gitlab-runner -f

# éªŒè¯ Runner é…ç½®
sudo gitlab-runner verify
```

### æ•°æ®åº“ç®¡ç†

```bash
# è¿›å…¥ MongoDB å®¹å™¨
docker exec -it for_health_mongodb mongosh

# æ‰‹åŠ¨å¤‡ä»½
/opt/for_health/backup.sh

# æ¢å¤å¤‡ä»½
docker exec -it for_health_mongodb mongorestore /backup/dump_YYYYMMDD_HHMMSS
```

### ç›‘æ§å’Œè°ƒè¯•

```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç† Docker èµ„æº
docker system prune -a

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -xe
```

---

## å…«ã€æ•…éšœæ’æŸ¥

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| Pipeline å¡åœ¨ pending | Runner æœªè¿æ¥ | æ£€æŸ¥ `sudo gitlab-runner status` |
| Docker é•œåƒæ‹‰å–å¤±è´¥ | ç½‘ç»œé—®é¢˜ | é…ç½®é•œåƒåŠ é€Ÿå™¨ |
| å®¹å™¨å¯åŠ¨å¤±è´¥ | é…ç½®é”™è¯¯ | æ£€æŸ¥ `.env.production` å’Œæ—¥å¿— |
| æ— æ³•è®¿é—®æœåŠ¡ | é˜²ç«å¢™/ç«¯å£ | æ£€æŸ¥å®‰å…¨ç»„å’Œ ufw |
| MongoDB è¿æ¥å¤±è´¥ | ç½‘ç»œ/é…ç½® | æ£€æŸ¥ docker-compose ç½‘ç»œé…ç½® |
| Runner æ‰§è¡Œå¤±è´¥ | æƒé™/é…ç½®é—®é¢˜ | æ£€æŸ¥ Runner é…ç½®å’Œ Docker æƒé™ |
| éƒ¨ç½²è„šæœ¬å¤±è´¥ | SSH æƒé™ | æ£€æŸ¥ SSH å¯†é’¥å’Œ CI/CD å˜é‡ |

### å¸¸è§é—®é¢˜è¯¦ç»†è§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1ï¼šGitLab Runner æ— æ³•æ‹‰å–é•œåƒ

```bash
# è§£å†³æ–¹æ¡ˆï¼šé…ç½®é•œåƒåŠ é€Ÿå™¨ï¼ˆå·²åœ¨ç¬¬äºŒæ­¥é…ç½®ï¼‰
sudo systemctl restart docker
sudo gitlab-runner restart
```

#### é—®é¢˜ 2ï¼šå®¹å™¨æ— æ³•è®¿é—®å¤–ç½‘

```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ DNS é…ç½®
sudo nano /etc/docker/daemon.json

# æ·»åŠ  DNS é…ç½®
{
  "dns": ["8.8.8.8", "114.114.114.114"]
}

sudo systemctl restart docker
```

#### é—®é¢˜ 3ï¼šç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æ¸…ç† Docker èµ„æº
docker system prune -a --volumes

# æ¸…ç†æ—¥å¿—
sudo journalctl --vacuum-time=7d
```

---

## ä¹ã€æˆæœ¬ä¼°ç®—

### æ–¹æ¡ˆäºŒé…ç½®ï¼ˆ4æ ¸8GBï¼‰æœˆåº¦æˆæœ¬

| é¡¹ç›® | è´¹ç”¨ |
|-----|------|
| ECS æœåŠ¡å™¨ï¼ˆ4æ ¸8GBï¼‰ | Â¥280-350/æœˆ |
| å…¬ç½‘å¸¦å®½ 10Mbps | Â¥50-80/æœˆ |
| æ•°æ®ç›˜ 100GB SSD | Â¥20-30/æœˆ |
| **æ€»è®¡** | **Â¥350-460/æœˆ** |

### ä¼˜åŒ–å»ºè®®

- **åŒ…å¹´åŒ…æœˆ**ï¼šè´­ä¹°åŒ…å¹´åŒ…æœˆå¯äº«å—æŠ˜æ‰£ï¼ˆçº¦ 7-8 æŠ˜ï¼‰
- **å­¦ç”Ÿè®¤è¯**ï¼šå­¦ç”Ÿè®¤è¯å¯äº«å—æ›´å¤šä¼˜æƒ 
- **æŒ‰éœ€è®¡è´¹**ï¼šåˆç†ä½¿ç”¨æŒ‰éœ€è®¡è´¹çš„å¸¦å®½
- **é¢„ç•™å®ä¾‹**ï¼šé•¿æœŸä½¿ç”¨å¯è´­ä¹°é¢„ç•™å®ä¾‹

### å¹´åº¦æˆæœ¬ä¼°ç®—

- **æŒ‰éœ€ä»˜è´¹**ï¼šÂ¥350-460/æœˆ Ã— 12 = Â¥4,200-5,520/å¹´
- **åŒ…å¹´è´­ä¹°ï¼ˆ8æŠ˜ï¼‰**ï¼šçº¦ Â¥3,360-4,416/å¹´
- **å­¦ç”Ÿä¼˜æƒ ï¼ˆ5æŠ˜ï¼‰**ï¼šçº¦ Â¥2,100-2,760/å¹´

---

## åã€åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–

- é…ç½® Redis ç¼“å­˜
- å¯ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº
- æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- å¯ç”¨ Nginx ç¼“å­˜

### 2. å®‰å…¨ä¼˜åŒ–

- é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
- å¯ç”¨ API é™æµ
- é…ç½® WAFï¼ˆWeb åº”ç”¨é˜²ç«å¢™ï¼‰
- å®šæœŸå®‰å…¨æ‰«æ

### 3. ç›‘æ§ä¼˜åŒ–

- éƒ¨ç½² Prometheus + Grafana ç›‘æ§
- é…ç½®å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶/é’‰é’‰/ä¼ä¸šå¾®ä¿¡ï¼‰
- æ—¥å¿—èšåˆåˆ†æï¼ˆELK Stackï¼‰

### 4. å¤‡ä»½ä¼˜åŒ–

- é…ç½®å¼‚åœ°å¤‡ä»½
- è‡ªåŠ¨ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨
- å®šæœŸæ¢å¤æµ‹è¯•

---

## é™„å½•

### A. å¸¸ç”¨ç«¯å£è¯´æ˜

| ç«¯å£ | æœåŠ¡ | è¯´æ˜ |
|------|------|------|
| 22 | SSH | æœåŠ¡å™¨ç™»å½• |
| 80 | HTTP | Web è®¿é—® |
| 443 | HTTPS | åŠ å¯† Web è®¿é—® |
| 8000 | FastAPI | åç«¯ API æœåŠ¡ |
| 27017 | MongoDB | æ•°æ®åº“ |
| 1025 | MailHog SMTP | é‚®ä»¶å‘é€ç«¯å£ |
| 8025 | MailHog Web | é‚®ä»¶ Web ç•Œé¢ |

### B. ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `MONGODB_URL` | MongoDB è¿æ¥åœ°å€ | `mongodb://mongodb:27017` |
| `DATABASE_NAME` | æ•°æ®åº“åç§° | `for_health_prod` |
| `SECRET_KEY` | JWT å¯†é’¥ | éšæœºå­—ç¬¦ä¸²ï¼ˆ32ä½ä»¥ä¸Šï¼‰ |
| `SMTP_HOST` | é‚®ä»¶æœåŠ¡å™¨åœ°å€ | `mailhog`ï¼ˆMailHogï¼‰æˆ– `smtp.gmail.com`ï¼ˆGmailï¼‰ |
| `SMTP_PORT` | é‚®ä»¶æœåŠ¡å™¨ç«¯å£ | `1025`ï¼ˆMailHogï¼‰æˆ– `587`ï¼ˆGmailï¼‰ |
| `SMTP_USER` | é‚®ä»¶ç”¨æˆ·å | MailHog å¯ä¸ºç©ºï¼ŒGmail éœ€å¡«å†™ |
| `SMTP_PASSWORD` | é‚®ä»¶å¯†ç  | MailHog å¯ä¸ºç©ºï¼ŒGmail éœ€åº”ç”¨ä¸“ç”¨å¯†ç  |

### C. å‚è€ƒèµ„æ–™

- [GitLab Runner å®˜æ–¹æ–‡æ¡£](https://docs.gitlab.com/runner/)
- [Docker å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [MongoDB å®˜æ–¹æ–‡æ¡£](https://www.mongodb.com/docs/)
- [Nginx å®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š

- **é¡¹ç›®**: for_health
- **GitLab**: https://gitlab.com/your-group/for_health
- **æ–‡æ¡£ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-11-15
