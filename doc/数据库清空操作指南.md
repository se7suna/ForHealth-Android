# 数据库清空操作指南

## ⚠️ 重要警告

**清空数据库是不可逆的操作！** 在执行以下任何操作之前，请确保：

1. ✅ 已经备份重要数据
2. ✅ 得到相关人员的授权
3. ✅ 了解操作的后果

---

## 方法一：使用 Python 脚本清空（推荐）

### 1. 连接到服务器

```bash
ssh <用户名>@124.70.161.90
```

### 2. 进入项目目录

```bash
cd /opt/for_health/backend
```

### 3. 运行清空脚本

```bash
# 如果在 Docker 容器内运行
docker exec -it for_health_backend python scripts/clear_database.py

# 或者进入容器后运行
docker exec -it for_health_backend bash
python scripts/clear_database.py
```

### 4. 选择操作

脚本提供三个选项：

- **选项 1**: 查看数据库信息（查看有多少数据）
- **选项 2**: 清空所有集合数据（保留集合结构）⭐ **推荐**
- **选项 3**: 完全删除数据库（包括集合结构）

**推荐使用选项 2**，因为它会保留集合结构，方便后续继续使用。

### 5. 确认操作

- 选项 2 需要输入 `YES` 确认
- 选项 3 需要输入 `DELETE DATABASE` 确认

---

## 方法二：使用 Docker 命令清空

### 1. SSH 连接到服务器

```bash
ssh <用户名>@124.70.161.90
cd /opt/for_health
```

### 2. 进入 MongoDB 容器

```bash
# 查看 MongoDB 容器名称
docker ps | grep mongo

# 进入 MongoDB 容器
docker exec -it for_health_mongodb mongosh
```

### 3. 在 MongoDB Shell 中执行清空操作

#### 方式 A：清空所有集合（保留集合结构）

```javascript
// 切换到目标数据库
use for_health_prod

// 查看所有集合
show collections

// 查看数据统计
db.stats()

// 清空所有集合（逐个清空）
db.users.deleteMany({})
db.foods.deleteMany({})
db.food_records.deleteMany({})
db.recipes.deleteMany({})
db.recipe_records.deleteMany({})
db.sports.deleteMany({})
db.sport_records.deleteMany({})
db.weights.deleteMany({})
// ... 根据实际集合名称添加其他集合

// 验证清空结果
db.users.countDocuments({})
db.foods.countDocuments({})
```

#### 方式 B：完全删除数据库

```javascript
// 切换到目标数据库
use for_health_prod

// 删除整个数据库（⚠️ 谨慎使用！）
db.dropDatabase()

// 验证删除结果
show dbs
```

### 4. 退出 MongoDB Shell

```javascript
exit
```

---

## 方法三：使用 Docker Compose 重建数据库

这种方法会完全删除数据卷并重新创建，适用于需要彻底清理的场景。

### 1. SSH 连接到服务器

```bash
ssh <用户名>@124.70.161.90
cd /opt/for_health
```

### 2. 停止服务并删除数据卷

```bash
# 停止所有服务
docker compose -f docker-compose.prod.yml down

# 查看数据卷
docker volume ls | grep for_health

# 删除 MongoDB 数据卷（⚠️ 这会永久删除所有数据！）
docker volume rm for_health_mongodb_data
```

### 3. 重新启动服务

```bash
# 重新启动服务（会创建新的空数据卷）
docker compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker compose -f docker-compose.prod.yml ps

# 查看后端日志
docker compose -f docker-compose.prod.yml logs -f backend
```

---

## 方法四：仅删除特定集合的数据

如果只想清空特定集合（比如只清空用户数据），可以：

### 使用 Python 脚本

在服务器上创建临时脚本 `clear_specific_collection.py`：

```python
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
import os
from dotenv import load_dotenv

load_dotenv(".env.production")

async def clear_collection(collection_name):
    MONGODB_URL = os.getenv("MONGODB_URL", "mongodb://mongodb:27017")
    DATABASE_NAME = os.getenv("DATABASE_NAME", "for_health_prod")

    client = AsyncIOMotorClient(MONGODB_URL)
    db = client[DATABASE_NAME]

    # 查看删除前的数量
    count_before = await db[collection_name].count_documents({})
    print(f"删除前: {collection_name} 有 {count_before} 条记录")

    # 删除所有文档
    result = await db[collection_name].delete_many({})
    print(f"✅ 已删除 {result.deleted_count} 条记录")

    client.close()

# 清空特定集合
asyncio.run(clear_collection("users"))  # 只清空 users 集合
```

运行：
```bash
docker exec -it for_health_backend python clear_specific_collection.py
```

### 使用 MongoDB Shell

```bash
docker exec -it for_health_mongodb mongosh

use for_health_prod
db.users.deleteMany({})  # 只清空 users 集合
```

---

## 清空后的验证

### 1. 检查数据库状态

```bash
# 进入 MongoDB 容器
docker exec -it for_health_mongodb mongosh

# 检查数据库
use for_health_prod
db.stats()
show collections

// 检查每个集合的记录数
db.users.countDocuments({})
db.foods.countDocuments({})
db.food_records.countDocuments({})
```

### 2. 测试应用是否正常

```bash
# 检查健康状态
curl http://localhost:8000/health

# 或从外部访问
curl http://124.70.161.90:8000/health
```

### 3. 重新初始化数据（如果需要）

如果需要初始化基础数据：

```bash
cd /opt/for_health/backend

# 运行初始化脚本（如果有）
docker exec -it for_health_backend python -m app.db_init.init_dataset
```

---

## 数据备份建议

在清空数据之前，强烈建议先备份：

### 使用 mongodump 备份

```bash
# 在服务器上执行
docker exec for_health_mongodb mongodump \
  --db=for_health_prod \
  --out=/backup/backup_$(date +%Y%m%d_%H%M%S)

# 查看备份
docker exec for_health_mongodb ls -lh /backup
```

### 恢复备份

```bash
# 如果需要恢复
docker exec for_health_mongodb mongorestore \
  --db=for_health_prod \
  /backup/backup_YYYYMMDD_HHMMSS/for_health_prod
```

### 导出备份到本地

```bash
# 从容器复制备份到服务器
docker cp for_health_mongodb:/backup ./backup_local

# 从服务器下载到本地
scp -r <用户名>@124.70.161.90:/opt/for_health/backup_local ./
```

---

## 常见问题

### Q1: 清空后应用无法启动？

**A**: 可能需要重新创建默认用户或初始数据。检查 `backend/app/db_init/init_dataset.py` 是否需要运行。

```bash
docker exec -it for_health_backend python -m app.db_init.init_dataset
```

### Q2: 数据没有被清空？

**A**: 检查是否连接到了正确的数据库。确认 `.env.production` 中的 `DATABASE_NAME` 配置。

```bash
# 检查环境变量
docker exec -it for_health_backend env | grep DATABASE_NAME
```

### Q3: 权限不足？

**A**: 确保 MongoDB 没有启用身份验证，或者使用了正确的用户名和密码。

### Q4: 清空后如何重新开始？

**A**:
1. 清空数据库后，应用会自动创建新的空集合
2. 如需初始数据，运行初始化脚本
3. 通过 API 创建新的测试用户和数据

---

## 常用集合名称

根据项目代码，主要的集合包括：

- `users` - 用户信息
- `foods` - 食物库
- `food_records` - 食物摄入记录
- `recipes` - 食谱库
- `recipe_records` - 食谱记录
- `sports` - 运动库
- `sport_records` - 运动记录
- `weights` - 体重记录

---

## 相关文件

- **清空脚本**: `backend/scripts/clear_database.py`
- **数据库配置**: `backend/.env.production`
- **Docker Compose**: `docker-compose.prod.yml`
- **初始化脚本**: `backend/app/db_init/init_dataset.py`

---

## 快速参考

### 查看数据库信息
```bash
docker exec -it for_health_mongodb mongosh
use for_health_prod
db.stats()
show collections
```

### 清空单个集合
```bash
docker exec -it for_health_mongodb mongosh
use for_health_prod
db.集合名.deleteMany({})
```

### 完全重置数据库
```bash
cd /opt/for_health
docker compose -f docker-compose.prod.yml down
docker volume rm for_health_mongodb_data
docker compose -f docker-compose.prod.yml up -d
```

---

## 联系方式

如有疑问，请联系项目负责人或查看 GitLab Issue。
