# For Health æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒåˆ†ç¦»éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

- [ç¯å¢ƒæ¶æ„](#ç¯å¢ƒæ¶æ„)
- [æœåŠ¡å™¨æ¸…ç†å’Œé‡å»º](#æœåŠ¡å™¨æ¸…ç†å’Œé‡å»º)
- [GitLab CI/CD é…ç½®](#gitlab-cicd-é…ç½®)
- [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ—ï¸ ç¯å¢ƒæ¶æ„

### ç¯å¢ƒåˆ’åˆ†

| ç¯å¢ƒ | åˆ†æ”¯ | é…ç½®æ–‡ä»¶ | Docker Compose | æœåŠ¡å™¨ | éƒ¨ç½²æ–¹å¼ |
|------|------|---------|----------------|--------|----------|
| **å¼€å‘ç¯å¢ƒ** | `develop` | `backend/.env` | `docker-compose.yml` | æœ¬åœ° | æ‰‹åŠ¨å¯åŠ¨ |
| **ç”Ÿäº§ç¯å¢ƒ** | `main` | `backend/.env.production` | `docker-compose.prod.yml` | åä¸ºäº‘ | ğŸ”„ è‡ªåŠ¨éƒ¨ç½² |

### ç«¯å£è§„åˆ’

| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| FastAPI Backend | 8000 | åç«¯ API |
| MongoDB | 27017 | æ•°æ®åº“ |
| MailHog SMTP | 1025 | é‚®ä»¶å‘é€ |
| MailHog Web UI | 8025 | é‚®ä»¶æŸ¥çœ‹ç•Œé¢ |
| Nginx HTTP | 80 | HTTP è®¿é—® |
| Nginx HTTPS | 443 | HTTPS è®¿é—® |

---

## ğŸ”§ æœåŠ¡å™¨æ¸…ç†å’Œé‡å»º

### æ­¥éª¤ä¸€: æ¸…ç† CD åˆ†æ”¯ä»£ç 

> âš ï¸ **é‡è¦**: æ‰§è¡Œå‰è¯·ç¡®ä¿å·²å¤‡ä»½é‡è¦æ•°æ®!

```bash
# 1. SSH ç™»å½•åä¸ºäº‘æœåŠ¡å™¨
ssh deploy@124.70.161.90

# 2. è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/for_health

# 3. å¤‡ä»½æ•°æ®åº“(å¦‚æœ‰é‡è¦æ•°æ®)
docker exec for_health_mongodb mongodump \
  --out /backup/dump_$(date +%Y%m%d_%H%M%S) \
  --db for_health_prod

# 4. åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose -f docker-compose.prod.yml down

# 5. å¤‡ä»½å½“å‰ä»£ç ç›®å½•
cd /opt
sudo tar -czf for_health_backup_$(date +%Y%m%d_%H%M%S).tar.gz for_health/

# 6. åˆ é™¤æ—§ä»£ç 
sudo rm -rf /opt/for_health

# 7. é‡æ–°åˆ›å»ºç›®å½•å¹¶è®¾ç½®æƒé™
sudo mkdir -p /opt/for_health
sudo chown deploy:deploy /opt/for_health
```

### æ­¥éª¤äºŒ: ä» main åˆ†æ”¯å…‹éš†ä»£ç 

```bash
# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd /opt/for_health

# ä½¿ç”¨ GitLab Personal Access Token å…‹éš†
git clone -b main https://oauth2:glpat-GEH0xrmO9z7gmXLPoh5lhm86MQp1OmliMnJzCw.01.120az29df@gitlab.com/se-2024-fall-project/for_health.git .

# éªŒè¯åˆ†æ”¯
git branch
git log --oneline -5
```

### æ­¥éª¤ä¸‰: é…ç½®ç”Ÿäº§ç¯å¢ƒ

```bash
# 1. ç¼–è¾‘ç”Ÿäº§ç¯å¢ƒé…ç½®
cd /opt/for_health/backend
nano .env.production

# 2. ä¿®æ”¹ä»¥ä¸‹å…³é”®é…ç½®:
# - SECRET_KEY: ä¿®æ”¹ä¸ºéšæœºç”Ÿæˆçš„å®‰å…¨å¯†é’¥(32ä½ä»¥ä¸Š)
# - DATABASE_NAME: for_health_prod
# - å¦‚éœ€ä½¿ç”¨çœŸå®é‚®ä»¶æœåŠ¡å™¨,ä¿®æ”¹ SMTP é…ç½®

# 3. ä¿å­˜å¹¶é€€å‡º (Ctrl+X, Y, Enter)
```

**ç”Ÿäº§ç¯å¢ƒ .env.production ç¤ºä¾‹:**

```bash
# æ•°æ®åº“é…ç½®
MONGODB_URL=mongodb://mongodb:27017
DATABASE_NAME=for_health_prod

# å®‰å…¨é…ç½® (âš ï¸ è¯·ä¿®æ”¹ä¸ºéšæœºå¯†é’¥!)
SECRET_KEY=your-random-32-char-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# é‚®ä»¶é…ç½® (ä½¿ç”¨ MailHog)
SMTP_HOST=mailhog
SMTP_PORT=1025
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=noreply@forhealth.com
SMTP_FROM_NAME=For Health

# åº”ç”¨é…ç½®
DEBUG=False
ENVIRONMENT=production
```

### æ­¥éª¤å››: å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

```bash
cd /opt/for_health

# 1. æ‹‰å–é•œåƒ
docker compose -f docker-compose.prod.yml pull

# 2. æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
docker compose -f docker-compose.prod.yml up -d --build

# 3. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose -f docker-compose.prod.yml ps

# 4. æŸ¥çœ‹åç«¯æ—¥å¿—
docker compose -f docker-compose.prod.yml logs -f backend

# 5. å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# 6. æµ‹è¯• API æ–‡æ¡£
curl http://124.70.161.90:8000/docs
```

---

## âš™ï¸ GitLab CI/CD é…ç½®

### æ‰€éœ€çš„ CI/CD å˜é‡

åœ¨ GitLab é¡¹ç›®ä¸­é…ç½®ä»¥ä¸‹å˜é‡:

**è·¯å¾„**: é¡¹ç›® â†’ Settings â†’ CI/CD â†’ Variables â†’ Add Variable

| Key | Value | Type | Protected | Masked |
|-----|-------|------|-----------|--------|
| `SSH_PRIVATE_KEY` | [æœåŠ¡å™¨ SSH ç§é’¥å†…å®¹] | File | âœ… Yes | âŒ No |
| `DEPLOY_SERVER_IP` | `124.70.161.90` | Variable | âœ… Yes | âŒ No |
| `DEPLOY_USER` | `deploy` | Variable | âœ… Yes | âŒ No |

### ç”Ÿæˆå’Œé…ç½® SSH å¯†é’¥

#### 1. åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆ SSH å¯†é’¥å¯¹

```bash
# ç™»å½•æœåŠ¡å™¨
ssh deploy@124.70.161.90

# ç”Ÿæˆå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -C "gitlab-ci-deploy" -f ~/.ssh/gitlab_deploy_key -N ""

# æ·»åŠ å…¬é’¥åˆ° authorized_keys
cat ~/.ssh/gitlab_deploy_key.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# æŸ¥çœ‹ç§é’¥(ç”¨äºæ·»åŠ åˆ° GitLab CI/CD å˜é‡)
cat ~/.ssh/gitlab_deploy_key
```

#### 2. å°†ç§é’¥æ·»åŠ åˆ° GitLab

1. å¤åˆ¶ä¸Šé¢å‘½ä»¤è¾“å‡ºçš„ç§é’¥å†…å®¹(åŒ…æ‹¬ `-----BEGIN ... -----` å’Œ `-----END ... -----`)
2. åœ¨ GitLab é¡¹ç›®ä¸­:
   - Settings â†’ CI/CD â†’ Variables â†’ Add Variable
   - **Key**: `SSH_PRIVATE_KEY`
   - **Value**: [ç²˜è´´ç§é’¥å†…å®¹]
   - **Type**: File
   - **Protected**: âœ… å‹¾é€‰
   - **Masked**: âŒ ä¸å‹¾é€‰

#### 3. æµ‹è¯• SSH è¿æ¥

```bash
# åœ¨æœ¬åœ°æµ‹è¯•(ä½¿ç”¨ç§é’¥æ–‡ä»¶)
ssh -i ~/.ssh/gitlab_deploy_key deploy@124.70.161.90

# åº”è¯¥èƒ½å¤Ÿå…å¯†ç™»å½•
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### å¼€å‘æµç¨‹

```mermaid
graph LR
    A[åŠŸèƒ½å¼€å‘] --> B[æäº¤åˆ° feature åˆ†æ”¯]
    B --> C[åˆ›å»º MR åˆ° main]
    C --> D[ä»£ç å®¡æŸ¥]
    D --> E[åˆå¹¶åˆ° main]
    E --> F[è‡ªåŠ¨è§¦å‘ CI/CD Pipeline]
    F --> G[è¿è¡Œæµ‹è¯•]
    G --> H{æµ‹è¯•é€šè¿‡?}
    H -->|æ˜¯| I[æ„å»ºæˆåŠŸ]
    H -->|å¦| J[ä¿®å¤é—®é¢˜]
    I --> K[æ‰‹åŠ¨è§¦å‘éƒ¨ç½²]
    K --> L[è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨]
    J --> A
```

### å…·ä½“æ“ä½œæ­¥éª¤

#### 1. æœ¬åœ°å¼€å‘å’Œæµ‹è¯•

```bash
# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/your-feature-name

# å¼€å‘ä»£ç ...
# æœ¬åœ°æµ‹è¯•...

# æäº¤ä»£ç 
git add .
git commit -m "feat: add new feature description"
git push origin feature/your-feature-name
```

#### 2. åˆ›å»º Merge Request

1. åœ¨ GitLab ä¸Šåˆ›å»º MR: `feature/your-feature-name` â†’ `main`
2. æ·»åŠ æè¿°å’Œç›¸å…³ issue é“¾æ¥
3. ç­‰å¾… CI/CD Pipeline è‡ªåŠ¨è¿è¡Œ
4. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡

#### 3. ä»£ç å®¡æŸ¥å’Œåˆå¹¶

1. å›¢é˜Ÿæˆå‘˜è¿›è¡Œä»£ç å®¡æŸ¥
2. ä¿®å¤å®¡æŸ¥æ„è§(å¦‚æœ‰)
3. å®¡æ‰¹é€šè¿‡å,åˆå¹¶åˆ° `main` åˆ†æ”¯

#### 4. è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

åˆå¹¶åˆ° `main` å:

1. GitLab CI/CD è‡ªåŠ¨è§¦å‘ Pipeline
2. è‡ªåŠ¨è¿è¡Œæµ‹è¯•é˜¶æ®µ
3. è‡ªåŠ¨è¿è¡Œæ„å»ºé˜¶æ®µ
4. **éƒ¨ç½²é˜¶æ®µéœ€è¦æ‰‹åŠ¨è§¦å‘** (å®‰å…¨è€ƒè™‘)

**æ‰‹åŠ¨è§¦å‘éƒ¨ç½²æ­¥éª¤:**

1. è¿›å…¥ GitLab é¡¹ç›®é¡µé¢
2. CI/CD â†’ Pipelines â†’ é€‰æ‹©æœ€æ–°çš„ Pipeline
3. æ‰¾åˆ° `deploy:production` ä»»åŠ¡
4. ç‚¹å‡» â–¶ï¸ æ’­æ”¾æŒ‰é’®æ‰‹åŠ¨è§¦å‘
5. ç­‰å¾…éƒ¨ç½²å®Œæˆ(çº¦ 2-3 åˆ†é’Ÿ)
6. éªŒè¯éƒ¨ç½²æˆåŠŸ: è®¿é—® http://124.70.161.90:8000/health

---

## ğŸ” éªŒè¯å’Œç›‘æ§

### éªŒè¯éƒ¨ç½²æˆåŠŸ

```bash
# 1. å¥åº·æ£€æŸ¥
curl http://124.70.161.90:8000/health

# é¢„æœŸè¾“å‡º:
# {
#   "status": "healthy",
#   "timestamp": "2025-11-23T...",
#   "service": "for_health_backend"
# }

# 2. è®¿é—® API æ–‡æ¡£
# æµè§ˆå™¨æ‰“å¼€: http://124.70.161.90:8000/docs

# 3. æŸ¥çœ‹ MailHog é‚®ä»¶
# æµè§ˆå™¨æ‰“å¼€: http://124.70.161.90:8025

# 4. ç™»å½•æœåŠ¡å™¨æŸ¥çœ‹æ—¥å¿—
ssh deploy@124.70.161.90
cd /opt/for_health
docker compose -f docker-compose.prod.yml logs -f backend
```

### ç›‘æ§æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### Q1: Pipeline å¡åœ¨ pending çŠ¶æ€?

**åŸå› **: GitLab Runner æœªè¿è¡Œæˆ–æœªè¿æ¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç™»å½•æœåŠ¡å™¨
ssh deploy@124.70.161.90

# æ£€æŸ¥ Runner çŠ¶æ€
sudo gitlab-runner status

# å¦‚æœæœªè¿è¡Œ,é‡å¯ Runner
sudo gitlab-runner restart

# éªŒè¯ Runner
sudo gitlab-runner verify
```

### Q2: éƒ¨ç½²è„šæœ¬ SSH è¿æ¥å¤±è´¥?

**åŸå› **: SSH å¯†é’¥é…ç½®é”™è¯¯æˆ–æœåŠ¡å™¨ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ GitLab CI/CD å˜é‡ä¸­çš„ `SSH_PRIVATE_KEY` æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ `DEPLOY_SERVER_IP` å’Œ `DEPLOY_USER` æ˜¯å¦æ­£ç¡®
3. åœ¨æœåŠ¡å™¨ä¸ŠéªŒè¯ `~/.ssh/authorized_keys` åŒ…å«å¯¹åº”çš„å…¬é’¥

### Q3: å®¹å™¨å¯åŠ¨å¤±è´¥?

**åŸå› **: ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯æˆ–ç«¯å£å†²çª

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose -f docker-compose.prod.yml logs backend

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep -E '8000|27017|1025|8025'

# é‡æ–°æ„å»ºé•œåƒ
docker compose -f docker-compose.prod.yml build --no-cache backend
docker compose -f docker-compose.prod.yml up -d
```

### Q4: æ•°æ®åº“è¿æ¥å¤±è´¥?

**åŸå› **: MongoDB å®¹å™¨æœªå¯åŠ¨æˆ–ç½‘ç»œé…ç½®é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥ MongoDB å®¹å™¨çŠ¶æ€
docker ps | grep mongodb

# è¿›å…¥ MongoDB å®¹å™¨æµ‹è¯•è¿æ¥
docker exec -it for_health_mongodb mongosh

# åœ¨ mongosh ä¸­æµ‹è¯•
show dbs
use for_health_prod
show collections
```

### Q5: å¦‚ä½•å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬?

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç™»å½•æœåŠ¡å™¨
ssh deploy@124.70.161.90
cd /opt/for_health

# æŸ¥çœ‹æäº¤å†å²
git log --oneline -10

# å›æ»šåˆ°æŒ‡å®šæäº¤
git checkout <commit-hash>

# é‡å¯æœåŠ¡
docker compose -f docker-compose.prod.yml down
docker compose -f docker-compose.prod.yml up -d --build

# å›åˆ° main åˆ†æ”¯
git checkout main
```

---

## ğŸ“ å…³é”®æ³¨æ„äº‹é¡¹

### âš ï¸ å®‰å…¨æ€§

1. **SECRET_KEY**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨éšæœºç”Ÿæˆçš„å¯†é’¥,ä¸è¦ä½¿ç”¨ç¤ºä¾‹å¯†é’¥
2. **SSH å¯†é’¥**: ç§é’¥åªä¿å­˜åœ¨ GitLab CI/CD å˜é‡ä¸­,ä¸è¦æäº¤åˆ°ä»£ç åº“
3. **ç¯å¢ƒå˜é‡**: æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡,ä¸è¦ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
4. **é˜²ç«å¢™**: ç¡®ä¿æœåŠ¡å™¨é˜²ç«å¢™åªå¼€æ”¾å¿…è¦ç«¯å£(22, 80, 443, 8000, 8025)

### ğŸ“¦ å¤‡ä»½ç­–ç•¥

1. **æ•°æ®åº“å¤‡ä»½**: æ¯å¤©è‡ªåŠ¨å¤‡ä»½ MongoDB æ•°æ®
2. **ä»£ç å¤‡ä»½**: Git ä»“åº“ä½œä¸ºä»£ç å¤‡ä»½
3. **é…ç½®å¤‡ä»½**: é‡è¦é…ç½®æ–‡ä»¶å•ç‹¬å¤‡ä»½

### ğŸ”„ éƒ¨ç½²æœ€ä½³å®è·µ

1. **æ‰‹åŠ¨è§¦å‘**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¿…é¡»æ‰‹åŠ¨è§¦å‘,é¿å…è¯¯éƒ¨ç½²
2. **æµ‹è¯•ä¼˜å…ˆ**: ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†éƒ¨ç½²
3. **å¥åº·æ£€æŸ¥**: éƒ¨ç½²åç«‹å³è¿›è¡Œå¥åº·æ£€æŸ¥
4. **æ—¥å¿—ç›‘æ§**: éƒ¨ç½²åæŸ¥çœ‹æ—¥å¿—,ç¡®ä¿æ— é”™è¯¯
5. **å›æ»šå‡†å¤‡**: è®°å½•éƒ¨ç½²å‰çš„ç‰ˆæœ¬,ä¾¿äºå¿«é€Ÿå›æ»š

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [GitLab CI/CD å®˜æ–¹æ–‡æ¡£](https://docs.gitlab.com/ee/ci/)
- [Docker Compose å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/compose/)
- [FastAPI éƒ¨ç½²æŒ‡å—](https://fastapi.tiangolo.com/deployment/)
- [MongoDB å¤‡ä»½æ¢å¤](https://www.mongodb.com/docs/manual/tutorial/backup-and-restore-tools/)

---

**æœ€åæ›´æ–°æ—¶é—´**: 2025-11-23
**ç»´æŠ¤è€…**: For Health å¼€å‘å›¢é˜Ÿ
